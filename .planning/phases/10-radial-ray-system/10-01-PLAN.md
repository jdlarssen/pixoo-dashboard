---
phase: 10-radial-ray-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/display/weather_anim.py
  - tests/test_weather_anim.py
autonomous: true
requirements: [ANIM-03, ANIM-04, ANIM-05, ANIM-06, ANIM-07, TEST-02]

must_haves:
  truths:
    - "Rays visibly radiate outward from the sun body in a downward-facing fan, not as random diagonal streaks"
    - "Rays fade in brightness as they travel away from the sun origin"
    - "Rays continuously respawn at the sun origin when they fade out or exit the zone"
    - "Far rays (9) render on bg layer behind text, near rays (5) render on fg layer in front"
    - "Animation starts with rays already distributed across the zone, no initial burst from origin"
    - "Ray head positions cluster near the sun origin significantly more than a random scatter"
  artifacts:
    - path: "src/display/weather_anim.py"
      provides: "Polar ray system in SunAnimation"
      contains: "_FAN_MIN_DEG"
    - path: "tests/test_weather_anim.py"
      provides: "Ray origin clustering test"
      contains: "test_ray_origin_clustering"
  key_links:
    - from: "src/display/weather_anim.py::SunAnimation._draw_ray"
      to: "math.cos/math.sin polar-to-cartesian conversion"
      via: "math.radians(angle) with distance advancement"
      pattern: "math\\.cos.*math\\.sin"
    - from: "src/display/weather_anim.py::SunAnimation._spawn_far"
      to: "SunAnimation._draw_ray"
      via: "polar ray state [angle, distance, speed, max_dist, base_alpha]"
      pattern: "_FAN_MIN_DEG.*_FAN_MAX_DEG"
    - from: "tests/test_weather_anim.py::test_ray_origin_clustering"
      to: "SunAnimation.far_rays + near_rays"
      via: "polar-to-cartesian position sampling after ticks"
      pattern: "distances_from_sun"
---

<objective>
Replace SunAnimation's random cartesian ray spawning with polar-coordinate radial rays emitting from the corner-anchored sun body at (63, 0). Rays spread in a 95-160 degree downward-facing fan, fade with distance, respawn continuously, and maintain the existing two-depth-layer system. Add a clustering test to verify rays originate from the sun, not randomly scattered.

Purpose: Transform disconnected diagonal streaks into natural radial sun beams emanating from the visible sun body, completing the v1.2 Sun Ray Overhaul milestone.
Output: Updated SunAnimation with polar ray system + ray clustering regression test.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-radial-ray-system/10-RESEARCH.md
@.planning/phases/09-sun-body/09-01-SUMMARY.md
@src/display/weather_anim.py
@tests/test_weather_anim.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SunAnimation rays from cartesian to polar radial system</name>
  <files>src/display/weather_anim.py</files>
  <action>
Rewrite the ray system in `SunAnimation` (lines 276-379) while preserving `_draw_sun_body()` and all class constants (`_SUN_X`, `_SUN_Y`, `_SUN_RADIUS`) unchanged.

**Add class constants for fan geometry:**
```python
_FAN_MIN_DEG = 95.0    # just past straight-down
_FAN_MAX_DEG = 160.0   # toward bottom-left corner
```

**Rewrite `_spawn_far(self, count)`:** Each ray is `[angle, distance, speed, max_dist, base_alpha]` (list of floats).
- `angle`: `random.uniform(_FAN_MIN_DEG, _FAN_MAX_DEG)`
- `speed`: `random.uniform(0.3, 0.6)` (slow, ambient)
- `max_dist`: `random.uniform(20.0, 30.0)`
- `base_alpha`: `random.randint(90, 130)` (moderate)
- `distance`: `random.uniform(0, max_dist)` (staggered start -- ANIM-07)

**Rewrite `_spawn_near(self, count)`:** Same structure, different ranges:
- `speed`: `random.uniform(0.5, 1.0)` (~1.5-2x parallax vs far)
- `max_dist`: `random.uniform(15.0, 25.0)`
- `base_alpha`: `random.randint(150, 210)` (bright)
- `distance`: `random.uniform(0, max_dist)` (staggered start -- ANIM-07)

**Rewrite `_draw_ray(self, draw, ray, color)`:**
1. Unpack: `angle, distance, speed, max_dist, base_alpha = ray`
2. Advance: `distance += speed; ray[1] = distance`
3. Polar-to-cartesian: `rad = math.radians(angle); x = _SUN_X + math.cos(rad) * distance; y = _SUN_Y + math.sin(rad) * distance`
4. Respawn check: if `distance >= max_dist` or `x < 0` or `x >= self.width` or `y < 0` or `y >= self.height`, then reset `ray[1] = 0.0` (respawn at origin -- ANIM-05). On respawn, also re-randomize angle, speed, max_dist, base_alpha for organic variety (prevents synchronization per Pitfall 5 in research).
5. Alpha fade: `fade = 1.0 - (distance / max_dist); alpha = int(base_alpha * fade)`. If `alpha < 15`, return (below LED visibility -- ANIM-04).
6. Draw ray segment: short line trailing back toward origin. `tail_len = 2` if `base_alpha < 140` else `3`. Compute tail point: `tx = x - cos(rad) * tail_len; ty = y - sin(rad) * tail_len`. Clamp to bounds. Draw `draw.line([(x2,y2), (x1,y1)], fill=(*color, alpha))`.

**Update `tick()`:** Keep `self._draw_sun_body(bg_draw)` at top (Pitfall 4). Far rays drawn on `bg_draw` with color `(240, 200, 40)`. Near rays drawn on `fg_draw` with color `(255, 240, 60)`. This preserves ANIM-06 depth layers.

**Update `reset()`:** Clear both ray lists and call `_spawn_far(9)` / `_spawn_near(5)` (same counts as before).

**Update class docstring** to describe polar radial rays instead of "diagonal falling" rays.

**Do NOT change:** `_draw_sun_body()`, `_SUN_X`, `_SUN_Y`, `_SUN_RADIUS`, or anything outside `SunAnimation`.
  </action>
  <verify>
    <automated>cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py -x -q</automated>
    <manual>All 71 existing tests pass. Sun body tests (TestSunBody) still pass unchanged. Color identity test (test_sun_particles_are_yellow_dominant) still passes since ray colors are still warm yellow.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>SunAnimation uses polar ray state [angle, distance, speed, max_dist, base_alpha] with 95-160 degree fan, distance-based alpha fade, respawn at origin, staggered initial distances, and depth layers preserved. All existing tests pass with zero regressions.</done>
</task>

<task type="auto">
  <name>Task 2: Add ray origin clustering test (TEST-02)</name>
  <files>tests/test_weather_anim.py</files>
  <action>
Add a new test class `TestRadialRays` in `test_weather_anim.py` after `TestSunBody` with the following test:

**`test_ray_origin_clustering(self)`:** Verifies ANIM-03/TEST-02 -- rays concentrate near the sun, not randomly scattered.
1. Create `SunAnimation()`, tick 10 times to let rays distribute.
2. For each ray in `anim.far_rays + anim.near_rays`, unpack `[angle, distance, speed, max_dist, base_alpha]`, convert to cartesian: `x = SunAnimation._SUN_X + math.cos(math.radians(angle)) * distance`, `y = SunAnimation._SUN_Y + math.sin(math.radians(angle)) * distance`.
3. Compute distance from sun center: `math.sqrt((x - _SUN_X)**2 + (y - _SUN_Y)**2)`.
4. Assert average distance < 20.0px (a random scatter across 64x24 from corner would average ~25-30px).
5. Error message: `f"Average ray distance from sun ({avg_dist:.1f}px) too large -- rays should cluster near origin, not scatter randomly"`.

**`test_rays_have_polar_state(self)`:** Structural guard that ray lists use the new polar format.
1. Create `SunAnimation()`.
2. Assert `len(anim.far_rays) == 9` and `len(anim.near_rays) == 5`.
3. For a sample ray `anim.far_rays[0]`, assert `len(ray) == 5` (5-element state).
4. Assert `ray[0]` (angle) is between 95 and 160 (within fan range).
5. Assert `ray[1]` (distance) >= 0 (non-negative).

**`test_rays_respawn_after_max_distance(self)`:** Verifies ANIM-05 -- rays reset distance when reaching max.
1. Create `SunAnimation()`.
2. Force a ray: set `ray[1]` (distance) to `ray[3]` (max_dist) - 0.1, so next tick pushes it past.
3. Tick once.
4. Assert `ray[1]` is near 0 (respawned) OR < speed value (just respawned and advanced).

**`test_staggered_initial_distances(self)`:** Verifies ANIM-07 -- not all rays start at distance 0.
1. Create `SunAnimation()`.
2. Collect all initial distances: `[ray[1] for ray in anim.far_rays + anim.near_rays]`.
3. Assert at least half have distance > 1.0 (staggered, not all at origin).
4. Assert not all distances are identical (variation present).

Ensure `import math` is already at top of file (it is -- line 13).
  </action>
  <verify>
    <automated>cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py::TestRadialRays -x -v</automated>
    <manual>All 4 new tests pass. Full test suite still passes (75 total).</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>TestRadialRays class exists with 4 tests: ray origin clustering, polar state structure, respawn behavior, and staggered initialization. All tests pass and validate ANIM-03, ANIM-05, ANIM-07, and TEST-02.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_weather_anim.py -x -q` -- all tests pass (75 total: 71 existing + 4 new)
2. `python -m pytest tests/test_weather_anim.py::TestSunBody -v` -- sun body tests unchanged and passing
3. `python -m pytest tests/test_weather_anim.py::TestColorIdentity::test_sun_particles_are_yellow_dominant -v` -- yellow color identity preserved
4. `python -m pytest tests/test_weather_anim.py::TestRadialRays -v` -- all 4 new ray tests pass
5. Grep for `_FAN_MIN_DEG` in weather_anim.py confirms polar constants present
6. Grep for `math.cos` in SunAnimation confirms polar-to-cartesian conversion
</verification>

<success_criteria>
- SunAnimation rays use polar state [angle, distance, speed, max_dist, base_alpha] instead of cartesian [x, y, speed, length, alpha]
- Rays emit within 95-160 degree fan from (63, 0)
- Alpha fades linearly with distance from origin
- Rays respawn at distance=0 when past max_distance or out of zone
- Far rays (9) on bg_draw, near rays (5) on fg_draw -- depth preserved
- Initial ray distances are staggered (not all at 0)
- 4 new tests in TestRadialRays all pass
- All 71 existing tests pass with zero regressions
- Sun body drawing completely untouched
</success_criteria>

<output>
After completion, create `.planning/phases/10-radial-ray-system/10-01-SUMMARY.md`
</output>
