---
phase: 03-weather
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/display/weather_icons.py
  - src/display/weather_anim.py
  - src/display/renderer.py
  - src/display/layout.py
  - src/main.py
  - tests/test_renderer.py
autonomous: false
requirements: [WTHR-01, WTHR-02, WTHR-03, WTHR-04]

must_haves:
  truths:
    - "Current temperature is displayed in the weather zone as a number without degree symbol or C"
    - "Negative temperatures show in blue text (no minus sign), positive in white/warm"
    - "A pixel art weather icon appears to the right of the clock digits in the clock zone"
    - "Weather icons have day and night variants"
    - "Today's high and low temperatures are visible in the weather zone"
    - "Weather zone has animated background matching current conditions (rain, sun, clouds, fog)"
    - "Rain indicator is visible when precipitation is expected (via animation and/or text)"
    - "Weather data refreshes on a 10-minute interval integrated into the main loop"
  artifacts:
    - path: "src/display/weather_icons.py"
      provides: "Pixel art icon definitions for ~8 weather groups with day/night variants"
      exports: ["get_weather_icon"]
    - path: "src/display/weather_anim.py"
      provides: "Animation frame generators for weather backgrounds"
      exports: ["get_animation"]
    - path: "src/display/renderer.py"
      provides: "Weather zone rendering with animated background, temperature text, and clock icon"
      contains: "render_weather_zone"
    - path: "src/display/layout.py"
      provides: "Weather zone color constants"
      contains: "COLOR_WEATHER"
    - path: "src/main.py"
      provides: "Main loop with weather fetch timer and animation tick"
      contains: "weather_data"
  key_links:
    - from: "src/display/renderer.py"
      to: "src/display/weather_icons.py"
      via: "get_weather_icon() called in render_frame"
      pattern: "get_weather_icon"
    - from: "src/display/renderer.py"
      to: "src/display/weather_anim.py"
      via: "Animation tick integrated in weather zone render"
      pattern: "get_animation|weather_anim"
    - from: "src/main.py"
      to: "src/providers/weather.py"
      via: "Independent 600-second weather fetch timer"
      pattern: "WEATHER_REFRESH_INTERVAL|fetch_weather_safe"
---

<objective>
Weather zone renderer with pixel art icons, animated backgrounds, clock icon, and main loop integration.

Purpose: Fill the 64x20 weather zone with live data: animated weather background, current temperature, high/low, and rain indicator. Place a weather icon next to the clock. Integrate weather fetch and animation tick into the main loop.
Output: Complete weather display on Pixoo 64 with all visual elements, verified on physical device.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-weather/03-RESEARCH.md
@.planning/phases/03-weather/03-CONTEXT.md
@.planning/phases/03-weather/03-01-SUMMARY.md
@.planning/phases/02-bus-departures/02-02-SUMMARY.md

@src/display/renderer.py
@src/display/layout.py
@src/main.py
@src/display/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Weather icons, animations, zone renderer, and main loop integration</name>
  <files>src/display/weather_icons.py, src/display/weather_anim.py, src/display/renderer.py, src/display/layout.py, src/main.py, tests/test_renderer.py</files>
  <action>
**1. Create `src/display/weather_icons.py` -- pixel art icon definitions:**

Create a module that provides small (10-12px) weather icons as PIL RGBA Images drawn programmatically (not sprite files -- too small for file management overhead).

Symbol code grouping (from RESEARCH.md):
- `clear`: clearsky, fair -> sun (day) / moon (night)
- `partcloud`: partlycloudy -> sun+cloud (day) / moon+cloud (night)
- `cloudy`: cloudy -> cloud (same day/night)
- `rain`: rain, lightrain, heavyrain, *rainshowers* -> cloud+drops
- `sleet`: sleet, lightsleet, heavysleet, *sleetshowers* -> cloud+mixed drops
- `snow`: snow, lightsnow, heavysnow, *snowshowers* -> cloud+flakes
- `thunder`: all *andthunder variants -> cloud+lightning bolt
- `fog`: fog -> horizontal lines/haze

Key function: `get_weather_icon(symbol_code: str, size: int = 10) -> Image.Image`
- Strip `_day`/`_night`/`_polartwilight` suffix to get base code
- Map base code to group using ICON_GROUP dict
- Determine day/night from suffix
- Return appropriate RGBA icon image
- Fallback to cloudy icon for unknown codes

Each icon drawn with PIL ImageDraw (ellipses, lines, rectangles). Keep simple -- these are 10px on a 64px display. Sun = yellow circle with ray lines. Moon = white/gray crescent. Cloud = overlapping white/gray ellipses. Rain = cloud + blue dots below. Snow = cloud + white dots. Thunder = cloud + yellow zigzag. Fog = gray horizontal lines.

**2. Create `src/display/weather_anim.py` -- animation frame generators:**

Create animation classes that produce 64x20 RGBA overlay images for the weather zone background.

Base: `WeatherAnimation` class with:
- `__init__(self, width: int = 64, height: int = 20)` -- zone dimensions
- `tick(self) -> Image.Image` -- return next frame as RGBA image
- `reset(self)` -- reset animation state

Concrete animations:
- `RainAnimation`: Maintain a list of raindrop particles (x, y). Each tick: move drops down 2-3px, wrap to top when off-screen. Draw as 1px blue dots. ~15-20 particles for light ambient effect.
- `SunAnimation`: Subtle warm glow -- draw faint yellow/orange gradient rays that slowly rotate or pulse. Keep very subtle (low alpha) so text remains readable.
- `CloudAnimation`: Gray cloud shapes that drift slowly left to right, wrapping around. 2-3 small cloud blobs at different speeds.
- `SnowAnimation`: Like rain but white dots, slower descent (1-2px), slight horizontal drift.
- `ThunderAnimation`: Same as rain but occasionally flash a bright frame (every ~20 ticks, brief white flash at low alpha).
- `FogAnimation`: Slow-moving horizontal gray bands at varying alpha.
- `ClearAnimation`: Minimal/no animation -- return transparent image.

Factory function: `get_animation(weather_group: str) -> WeatherAnimation`
- Maps group name to animation class
- "clear" maps to ClearAnimation (day) or ClearAnimation (night -- could add subtle star twinkle later)

IMPORTANT: Keep alpha values low (30-60 range for most effects) so text overlay remains readable. Animations are ambient background, not foreground.

**3. Update `src/display/layout.py` -- add weather color constants:**

Add color constants:
- `COLOR_WEATHER_TEMP` = (255, 255, 255) -- white for positive temperatures
- `COLOR_WEATHER_TEMP_NEG` = (100, 160, 255) -- blue for negative temperatures (per user decision: blue instead of minus sign)
- `COLOR_WEATHER_HILO` = (140, 140, 140) -- dim gray for high/low text
- `COLOR_WEATHER_RAIN` = (80, 160, 255) -- blue tint for rain indicator text

**4. Update `src/display/renderer.py` -- weather zone + clock icon rendering:**

Add `render_weather_zone()` helper function (follows bus zone pattern):
- Accept draw, state, fonts, and an animation frame (Image)
- Composite animation background first (paste RGBA onto weather zone region)
- Render current temperature:
  - Use "small" font (5x8) for the number
  - No degree symbol, no "C" -- just the number (per user decision)
  - Negative temps: blue text color (`COLOR_WEATHER_TEMP_NEG`), show absolute value (no minus sign)
  - Positive temps: white text (`COLOR_WEATHER_TEMP`)
  - Position: left side of weather zone, vertically centered-ish (Claude's discretion on exact y offset)
- Render high/low:
  - Use "tiny" font (4x6) for compact display
  - Format: show high and low values (e.g., "H8 L2" or stacked, Claude's discretion based on pixel budget)
  - Color: dim gray (`COLOR_WEATHER_HILO`)
  - Position: right side or below current temp based on available space
- Rain indicator:
  - If `weather_precip_mm > 0`: the animated rain background serves as primary indicator
  - Optionally add small text indicator at Claude's discretion (e.g., rain amount)
- Handle None state gracefully: show placeholder (dim "---" text) when weather_temp is None

Add clock icon rendering to `render_frame()`:
- After drawing clock time text, place the weather icon to its RIGHT
- Calculate clock text width using font.getbbox() to find the right edge
- Paste the icon from `get_weather_icon(state.weather_symbol)` at (clock_text_right + 2px, CLOCK_ZONE.y + 1px)
- Only draw if state.weather_symbol is not None
- Icon should fit within the remaining ~20px of clock zone width

Update `render_frame()` to:
- Accept an optional `anim_frame: Image.Image | None = None` parameter for the weather animation overlay
- Call `render_weather_zone(draw, state, fonts, anim_frame)` instead of the "VÃ†R" placeholder
- Call clock icon rendering after drawing time text

**5. Update `src/main.py` -- weather fetch and animation tick:**

Add weather integration to the main loop:
- Import `fetch_weather_safe` from providers.weather, `WEATHER_REFRESH_INTERVAL` from config
- Import `get_animation`, `WeatherAnimation` from display.weather_anim
- Import `symbol_to_group` from display.weather_icons (or weather_anim, wherever the mapping lives)
- Add tracking variables alongside bus:
  - `last_weather_fetch = 0.0`
  - `weather_data: WeatherData | None = None`
  - `weather_anim: WeatherAnimation | None = None`
  - `anim_frame: Image | None = None`
- Weather fetch cycle (independent 600-second timer, same pattern as bus):
  - When fetching, update `weather_data` via `fetch_weather_safe(WEATHER_LAT, WEATHER_LON)`
  - If weather data changed (different symbol group), swap animation: `weather_anim = get_animation(group)`
- Animation tick:
  - If `weather_anim` is not None: call `anim_frame = weather_anim.tick()` each loop iteration
  - This means the loop needs to run faster when animation is active
  - Strategy: reduce sleep from 1s to 0.25s (4 FPS) when weather animation is active
  - Still only push frame to device when state changes OR animation ticked (use a separate dirty flag for animation)
- Update `DisplayState.from_now()` call to pass `weather_data`
- Pass `anim_frame` to `render_frame()`
- Maintain a separate `last_anim_frame` to detect animation changes and push new frames

Rate limit device pushes: even with animation running, don't push more than ~4 frames/second. The 0.25s sleep naturally limits this.

**6. Update `tests/test_renderer.py` -- weather zone rendering tests:**

Add tests:
- Weather zone renders temperature text when weather_temp is set
- Weather zone renders placeholder when weather_temp is None
- Negative temperature uses blue color (verify pixel color at text position)
- Clock icon renders when weather_symbol is set
- Clock icon does not render when weather_symbol is None
- render_frame accepts anim_frame parameter without error
- Target: 6+ new weather rendering tests
  </action>
  <verify>
Run `cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/ -v` -- all tests pass.
Run `cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_renderer.py -v` -- new weather tests pass.
Run `python -c "from src.display.weather_icons import get_weather_icon; icon = get_weather_icon('clearsky_day'); print(icon.size, icon.mode)"` -- prints size and RGBA mode.
Run `python -c "from src.display.weather_anim import get_animation; a = get_animation('rain'); f = a.tick(); print(f.size, f.mode)"` -- prints (64, 20) RGBA.
Run `python src/main.py --simulated --save-frame` briefly (Ctrl+C after a few seconds) and check debug_frame.png shows weather data (or placeholder if API unreachable).
  </verify>
  <done>
Weather icons drawn programmatically for 8 groups with day/night variants. Animated backgrounds created for rain, sun, clouds, snow, thunder, fog. Weather zone renders temperature (blue for negative), high/low, and rain indicator. Clock zone shows weather icon next to time. Main loop fetches weather every 10 minutes and ticks animation at 4 FPS.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify weather display on physical Pixoo 64</name>
  <files>debug_frame.png</files>
  <action>
CHECKPOINT: Human verification of weather display on the physical Pixoo 64.

Run `python src/main.py --ip {YOUR_PIXOO_IP}` (or `--simulated` for simulator).

Verify on the physical Pixoo 64 display:
1. Clock zone: time digits with a small weather icon to their right
2. Date zone: unchanged Norwegian date
3. Bus zone: unchanged bus departures
4. Weather zone (bottom 20px): current temperature number, high/low values, animated background
5. Check weather zone animation: does the background animate based on current Trondheim weather?
6. Check temperature display: number only, no degree symbol or "C"
7. Check `debug_frame.png` if using `--save-frame` for a static snapshot
8. Wait 10+ minutes to confirm weather data refreshes

Common issues to check:
- Is the weather icon visible next to the clock? (small, so look closely)
- Is the temperature text readable over the animation? (animation should be subtle)
- Are the high/low values visible?
  </action>
  <verify>Visual confirmation on physical device or simulator that all weather elements display correctly.</verify>
  <done>Weather display verified: icon next to clock, temperature without degree symbol, high/low visible, animated background active, rain indicator working when applicable.</done>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -v` -- all tests pass (existing + new weather tests)
- Physical device or simulator shows weather data in the weather zone
- Weather icon visible next to clock digits
- Animation runs smoothly without device lag
- Temperature display: number only, blue for negative, white for positive
- High/low temperatures visible
- Weather refreshes every 10 minutes (check logs)
</verification>

<success_criteria>
- Current temperature displayed from MET data (WTHR-01)
- Pixel art weather icon in clock zone matches conditions (WTHR-02)
- Today's high/low visible in weather zone (WTHR-03)
- Rain indicator via animated background when precipitation expected (WTHR-04)
- Animation runs at ~4 FPS without device issues
- All tests pass, no regressions
- Verified on physical Pixoo 64 device
</success_criteria>

<output>
After completion, create `.planning/phases/03-weather/03-02-SUMMARY.md`
</output>
