---
phase: 09-sun-body
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/display/weather_anim.py
  - tests/test_weather_anim.py
autonomous: true
requirements:
  - ANIM-01
  - ANIM-02
  - TEST-01

must_haves:
  truths:
    - "A visible quarter-sun arc appears in the top-right corner of the weather zone, recognizable as a sun"
    - "The sun body has a two-layer glow -- a dimmer outer ring and a brighter warm-yellow inner fill"
    - "No sun pixels render outside the 64x24 weather zone image bounds (PIL auto-clips)"
    - "Existing ray animation continues to function (no regression)"
    - "All sun body tests pass with updated position, radius, and clipping assertions"
  artifacts:
    - path: "src/display/weather_anim.py"
      provides: "Updated SunAnimation with corner-anchored sun body"
      contains: "_SUN_X = 63"
    - path: "tests/test_weather_anim.py"
      provides: "Updated TestSunBody with new position and boundary assertions"
      contains: "test_sun_body_clipped_at_boundary"
  key_links:
    - from: "tests/test_weather_anim.py"
      to: "src/display/weather_anim.py"
      via: "SunAnimation._SUN_X, _SUN_Y, _SUN_RADIUS class constants"
      pattern: "SunAnimation\\._SUN_(X|Y|RADIUS)"
    - from: "src/display/weather_anim.py::_draw_sun_body"
      to: "src/display/weather_anim.py::tick"
      via: "bg_draw call on line 354"
      pattern: "self\\._draw_sun_body\\(bg_draw\\)"
---

<objective>
Replace the small sun circle (r=3 at 48,4) with a larger corner-anchored quarter-sun at the top-right of the weather zone (center 63,0 with r=8), featuring a two-layer glow. Update tests to verify the new position, radius, and boundary clipping.

Purpose: Establish the visible sun body that Phase 10's radial ray system will emit from. The sun must be recognizable at a glance on the 64x24 LED weather zone.

Output: Updated `SunAnimation` class with corner-anchored sun body and passing `TestSunBody` tests.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-sun-body/09-CONTEXT.md
@.planning/phases/09-sun-body/09-RESEARCH.md
@src/display/weather_anim.py
@tests/test_weather_anim.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SunAnimation sun body to corner-anchored quarter-sun with two-layer glow</name>
  <files>src/display/weather_anim.py</files>
  <action>
Modify the `SunAnimation` class in `src/display/weather_anim.py`:

1. **Update class constants** (lines ~287-289):
   - `_SUN_X = 63` (was 48) -- push center to right edge per user locked decision
   - `_SUN_Y = 0` (was 4) -- push center to top edge per user locked decision
   - `_SUN_RADIUS = 8` (was 3) -- larger radius for recognizable corner arc (research recommends 8; r=7 from ANIM-01 adjusted per user discretion for corner placement)

2. **Rewrite `_draw_sun_body()` method** (lines ~333-345):
   - Calculate glow radius as `r + 2` (glow spread of +2px, visible but not overwhelming per research)
   - Draw outer glow ellipse FIRST (larger, dimmer): `draw.ellipse([cx - glow_r, cy - glow_r, cx + glow_r, cy + glow_r], fill=(255, 200, 40, 60))` -- alpha 60 is well above LED visibility threshold of ~15
   - Draw inner body ellipse ON TOP (smaller, brighter): `draw.ellipse([cx - r, cy - r, cx + r, cy + r], fill=(255, 220, 60, 200))` -- alpha 200 matches current inner brightness
   - Update the docstring to describe corner-anchored quarter-sun arc
   - PIL's `ImageDraw.ellipse()` auto-clips to image bounds -- NO manual clipping code needed

3. **Do NOT modify** any ray methods (`_spawn_far`, `_spawn_near`, `_draw_ray`, `tick()` ray loops, `reset()`). Ray overhaul is Phase 10. Only the three class constants and the `_draw_sun_body()` method change.

Color rationale: Inner (255, 220, 60) is warm yellow; outer (255, 200, 40) is slightly deeper/more orange for visual depth. Both are in the warm yellow family per user decision.
  </action>
  <verify>
    <automated>cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py::TestSunBody -x -v 2>&1 | tail -20</automated>
    <manual>Tests will fail until Task 2 updates them -- that's expected. Verify the code change is syntactically correct by importing: python -c "from src.display.weather_anim import SunAnimation; print(SunAnimation._SUN_X, SunAnimation._SUN_Y, SunAnimation._SUN_RADIUS)"</manual>
    <sampling_rate>run after this task, before Task 2</sampling_rate>
  </verify>
  <done>SunAnimation._SUN_X == 63, _SUN_Y == 0, _SUN_RADIUS == 8. _draw_sun_body() draws two concentric ellipses (outer glow r+2 at alpha 60, inner body r at alpha 200). No ray methods touched.</done>
</task>

<task type="auto">
  <name>Task 2: Update TestSunBody tests for new corner-anchored position and boundary clipping</name>
  <files>tests/test_weather_anim.py</files>
  <action>
Rewrite the `TestSunBody` class in `tests/test_weather_anim.py` (lines ~603-632):

1. **`test_sun_body_produces_warm_pixels_at_position()`**:
   - Do NOT check the exact corner pixel (63, 0) -- PIL rasterization at exact boundary corners can be inconsistent (pitfall 5 from research)
   - Instead check a pixel clearly within the visible arc, e.g., `(58, 3)` or `(59, 2)` -- these are well inside the body radius from center (63, 0) at r=8
   - Assert alpha >= 150 (body fill is 200)
   - Assert R > B + 50 (warm yellow check, same pattern as current)

2. **`test_sun_body_has_glow()`**:
   - Calculate glow check position: a pixel just outside the body radius but within the glow radius
   - Use `cx - r - 1` for glow x, with a visible y coordinate (e.g., y=2)
   - Guard with `if 0 <= glow_x < 64` (glow pixel might be off-screen depending on exact radius)
   - Assert alpha > 0 for glow detection

3. **`test_sun_body_clipped_at_boundary()`** (NEW test, replaces or augments ray check):
   - Assert `bg.size == (64, 24)` (image bounds enforced)
   - Count non-transparent pixels in bg layer: `sum(1 for x in range(64) for y in range(24) if bg.getpixel((x, y))[3] > 0)`
   - Assert non_transparent > 30 (sun is visibly present, not entirely clipped) -- research shows r=8 at (63,0) gives ~64 body pixels
   - This verifies ANIM-01's clipping requirement

4. **Keep `test_sun_animation_still_has_rays()`** unchanged -- it verifies ray particles still work alongside the new body (regression guard per pitfall 4 from research). This test does NOT reference sun position constants.

The test patterns follow existing conventions in the file: direct `SunAnimation()` instantiation, `bg, fg = anim.tick()`, `bg.getpixel()` assertions.
  </action>
  <verify>
    <automated>cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py::TestSunBody -x -v</automated>
    <manual>All 4 TestSunBody tests pass (3 updated + 1 existing ray check unchanged)</manual>
    <sampling_rate>run after this task commits, before plan completion</sampling_rate>
  </verify>
  <done>All TestSunBody tests pass. Tests verify: (1) warm yellow pixels at visible arc position, (2) glow detected around body, (3) image bounds enforce clipping and sun is visibly present, (4) ray particles still active (unchanged).</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_weather_anim.py::TestSunBody -x -v` -- all 4 tests pass
2. `python -m pytest tests/test_weather_anim.py -x -v` -- full test file passes (no regressions in other animation tests)
3. `python -c "from src.display.weather_anim import SunAnimation; a = SunAnimation(); bg, fg = a.tick(); print('bg size:', bg.size, 'non-transparent:', sum(1 for x in range(64) for y in range(24) if bg.getpixel((x,y))[3] > 0))"` -- confirms sun renders with significant visible pixels
</verification>

<success_criteria>
- SunAnimation._SUN_X == 63, _SUN_Y == 0, _SUN_RADIUS == 8
- _draw_sun_body() uses two concentric ellipses (glow r+2 at alpha 60, body r at alpha 200)
- All TestSunBody tests pass (warm pixels, glow, clipping, rays)
- Full test_weather_anim.py passes with no regressions
- No ray methods (_spawn_far, _spawn_near, _draw_ray, tick ray loops) modified
</success_criteria>

<output>
After completion, create `.planning/phases/09-sun-body/09-01-SUMMARY.md`
</output>
