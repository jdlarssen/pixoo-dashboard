---
phase: 07-weather-color-fix
plan: 02
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - tests/test_weather_anim.py
autonomous: true
requirements:
  - FARGE-03

must_haves:
  truths:
    - "Tests assert rain particles are blue-dominant (B channel > R and G by a margin)"
    - "Tests assert snow particles are white-ish (all channels high, low spread)"
    - "Tests assert sun particles are yellow-dominant (R and G high, B low)"
    - "Tests assert rain text color has sufficient luminance contrast against rain particle average color"
    - "Tests use channel-dominance properties, NOT exact RGB value assertions"
  artifacts:
    - path: "tests/test_weather_anim.py"
      provides: "TestColorIdentity class with channel-dominance and contrast assertions"
      contains: "class TestColorIdentity"
  key_links:
    - from: "tests/test_weather_anim.py"
      to: "src/display/weather_anim.py"
      via: "Imports animation classes and samples pixel colors from tick() output"
      pattern: "from src.display.weather_anim import"
    - from: "tests/test_weather_anim.py"
      to: "src/display/layout.py"
      via: "Imports COLOR_WEATHER_RAIN for contrast ratio check"
      pattern: "from src.display.layout import COLOR_WEATHER_RAIN"
---

<objective>
Add color-identity regression tests that prevent future color clashes between weather animation particles and text. Tests assert structural color properties (channel dominance, luminance contrast) rather than exact RGB values, so they survive minor palette tweaks while catching hue-family collisions.

Purpose: FARGE-03 requires regression tests that prevent the rain text/particle indistinguishability from ever returning. Channel-dominance assertions are the right abstraction -- they encode "rain is blue" without encoding "rain is exactly (30, 80, 220)".

Output: New TestColorIdentity class in test_weather_anim.py with 7-8 tests covering all animation types + text contrast.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-weather-color-fix/07-RESEARCH.md
@.planning/phases/07-weather-color-fix/07-01-SUMMARY.md
@src/display/weather_anim.py
@src/display/layout.py
@tests/test_weather_anim.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add color-identity regression tests</name>
  <files>tests/test_weather_anim.py</files>
  <action>
Add a new `TestColorIdentity` class to `tests/test_weather_anim.py` (below the existing `TestAnimationVisibility` class). This class validates that weather animations maintain their intended color identity and that text colors contrast sufficiently with particle colors.

**Helper functions (module-level or as class methods):**

1. `_sample_particle_rgb(anim, num_ticks=5)` -- Collect all non-transparent pixel RGB values from multiple animation ticks. For each tick, iterate both bg and fg layers, check every pixel, and collect `(r, g, b)` for pixels where `a > 0`. Return the list of RGB tuples.

2. `relative_luminance(r, g, b)` -- WCAG 2.0 relative luminance formula. Linearize each channel: `c/255 -> if c <= 0.03928: c/12.92 else ((c+0.055)/1.055)**2.4`. Return `0.2126*R + 0.7152*G + 0.0722*B`.

3. `contrast_ratio(color1, color2)` -- Takes two `(r, g, b)` tuples, computes relative luminance for each, returns `(lighter + 0.05) / (darker + 0.05)`.

**Test methods in TestColorIdentity:**

1. `test_rain_particles_are_blue_dominant` -- Sample RainAnimation colors. Assert average B > average R + 20 AND average B > average G + 20. Use `min_delta=20` to allow some flexibility.

2. `test_snow_particles_are_white_ish` -- Sample SnowAnimation colors. Assert minimum of (avg_R, avg_G, avg_B) >= 180 AND channel spread (max - min) <= 50. Snow should be bright with all channels high.

3. `test_sun_particles_are_yellow_dominant` -- Sample SunAnimation colors. Assert average R > average B + 50 AND average G > average B + 30. Yellow = high R + high G, low B.

4. `test_cloud_particles_are_grey` -- Sample CloudAnimation colors. Assert channel spread (max - min of averages) <= 40. Clouds should be neutral grey (no strong color dominance).

5. `test_fog_particles_are_grey` -- Sample FogAnimation colors. Same assertion as clouds -- neutral grey, low channel spread.

6. `test_rain_text_contrasts_with_rain_particles` -- Import `COLOR_WEATHER_RAIN` from layout.py. Sample RainAnimation average particle color. Compute contrast ratio between text color and average particle RGB. Assert ratio >= 2.5 (LED displays have high inherent contrast on black, so lower than WCAG 4.5:1 is acceptable).

7. `test_rain_and_snow_particles_are_distinguishable` -- Sample both RainAnimation and SnowAnimation average colors. Compute the Euclidean distance in RGB space: `sqrt((r1-r2)^2 + (g1-g2)^2 + (b1-b2)^2)`. Assert distance >= 50. Rain (blue) and snow (white) must not look identical.

8. `test_thunder_inherits_rain_blue_dominance` -- Sample ThunderAnimation colors (use enough ticks to avoid flash frames dominating). The rain component should still produce blue-dominant pixels. Assert that among sampled colors, at least 30% have B > R + 10 and B > G + 10. (Thunder also has white flash/bolt pixels, so we check proportion rather than average.)

**Style notes:**
- Follow existing test file patterns (class-based, descriptive names, assert with f-string messages)
- Use `get_flattened_data()` NOT `getdata()` for Pillow pixel access (Pillow >=12.1.0 convention per Phase 6 decision)
- The helpers (`relative_luminance`, `contrast_ratio`) can be module-level functions since they are pure math
- Keep delta/threshold values generous enough to survive minor palette tweaks but tight enough to catch hue-family collisions (the whole point of these tests)
  </action>
  <verify>
Run: `cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py -v`

All tests must pass, including both existing `TestAnimationVisibility` tests AND new `TestColorIdentity` tests.

Then run full suite: `python -m pytest -v` -- 0 failures.
  </verify>
  <done>
- TestColorIdentity class exists in test_weather_anim.py with 8 test methods
- All 8 tests pass against the updated color palette from Plan 01
- Tests use channel-dominance properties, NOT exact RGB value assertions
- Rain text contrast ratio >= 2.5 against rain particle average
- Rain and snow particles are distinguishable (RGB distance >= 50)
- Thunder test confirms rain-blue inheritance
- Full test suite passes with 0 failures
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_weather_anim.py::TestColorIdentity -v` -- all 8 color-identity tests pass
2. `python -m pytest -v` -- full suite passes (0 failures)
3. Inspect test code: no `assert color == (exact, rgb, values)` patterns -- only channel-dominance and contrast ratio checks
4. `contrast_ratio` function uses WCAG relative luminance formula
</verification>

<success_criteria>
- 8 color-identity regression tests exist and pass
- Tests would catch a regression to the old color scheme (rain text blue on blue particles would fail the contrast test)
- Tests survive reasonable palette tweaks (e.g., changing rain from (30,80,220) to (25,75,230) should still pass)
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-weather-color-fix/07-02-SUMMARY.md`
</output>
