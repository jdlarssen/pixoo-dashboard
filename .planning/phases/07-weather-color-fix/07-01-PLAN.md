---
phase: 07-weather-color-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/display/layout.py
  - src/display/weather_anim.py
autonomous: true
requirements:
  - FARGE-01
  - FARGE-02

must_haves:
  truths:
    - "Rain text color (COLOR_WEATHER_RAIN) is white, not blue -- maximum contrast against all animation types"
    - "All 8 weather animation types have vivid, saturated RGB particle colors distinct from each other"
    - "Alpha values in weather_anim.py are unchanged from v1.0 values"
    - "Snow far-flakes are brighter/whiter than before, not grey-blue"
    - "Sun particles are vivid warm yellow with clear hue separation from rain blue"
  artifacts:
    - path: "src/display/layout.py"
      provides: "Updated COLOR_WEATHER_RAIN constant (white)"
      contains: "COLOR_WEATHER_RAIN = (255, 255, 255)"
    - path: "src/display/weather_anim.py"
      provides: "Updated particle RGB values for all 6 animation classes"
      contains: "30, 80, 220"
  key_links:
    - from: "src/display/layout.py"
      to: "src/display/renderer.py"
      via: "COLOR_WEATHER_RAIN import used in rain text rendering"
      pattern: "COLOR_WEATHER_RAIN"
    - from: "src/display/weather_anim.py"
      to: "src/display/renderer.py"
      via: "Animation tick() produces layers composited by _composite_layer()"
      pattern: "anim_layers"
---

<objective>
Tune the entire weather color palette -- both text colors in layout.py and particle RGB values in weather_anim.py -- to make all weather animations vivid and visually distinct on the physical Pixoo 64 LED display.

Purpose: Fix the blocking issue where rain text and rain particles are both blue and indistinguishable, and simultaneously improve the "muddy" appearance of all 8 animation types on LED hardware.

Output: Updated color constants in layout.py and particle fill colors in weather_anim.py. No new files, no structural changes, no alpha modifications.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-weather-color-fix/07-RESEARCH.md
@src/display/layout.py
@src/display/weather_anim.py
@src/display/renderer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update text color constants and particle RGB values</name>
  <files>src/display/layout.py, src/display/weather_anim.py</files>
  <action>
Update the weather color palette across both files. Change RGB channels ONLY -- do NOT modify any alpha values (these were empirically tuned in v1.0 for LED visibility).

**layout.py text color changes:**
- `COLOR_WEATHER_RAIN`: Change from `(50, 180, 255)` to `(255, 255, 255)` -- white for maximum contrast against ALL animation particle colors. This is the key fix for FARGE-01.
- `COLOR_WEATHER_TEMP`: Change from `(255, 200, 50)` to `(255, 220, 50)` -- slightly warmer yellow, already works well but small vibrancy bump.
- `COLOR_WEATHER_HILO`: Change from `(120, 180, 160)` to `(120, 200, 160)` -- slightly more green-teal for vibrancy on LED.
- `COLOR_WEATHER_TEMP_NEG`: Keep `(80, 200, 255)` -- monitor for rain collision during hardware UAT but do not change preemptively.
- Update the inline comments on changed constants to document the reason (e.g., "White for max contrast against all animations").

**weather_anim.py particle RGB changes (preserve all alpha values exactly):**

RainAnimation:
- Far drops: `(40, 90, 200, 100)` -> `(30, 80, 220, 100)` -- more saturated blue (lower R, raise B, keep alpha 100)
- Near drops: `(60, 140, 255, 200)` -> `(50, 120, 255, 200)` -- vivid blue (lower R/G, keep B and alpha 200)

SnowAnimation:
- Far flakes: `(200, 210, 230, 90)` -> `(220, 230, 255, 90)` -- cool white instead of grey-blue (raise all channels, keep alpha 90)
- Near flakes: Keep `(255, 255, 255, 180)` in `_draw_crystal()` -- already white, good

CloudAnimation:
- Far clouds: `(140, 150, 160, 60)` -> `(150, 160, 180, 60)` -- slightly more blue-grey (keep alpha 60)
- Far cloud secondary: `(140, 150, 160, 45)` -> `(150, 160, 180, 45)` -- match primary hue shift (keep alpha 45)
- Near clouds: `(180, 190, 200, 90)` -> `(190, 200, 220, 90)` -- slightly more blue-grey (keep alpha 90)
- Near cloud secondary: `(180, 190, 200, 70)` -> `(190, 200, 220, 70)` -- match primary hue shift (keep alpha 70)

SunAnimation:
- Far rays: `(220, 180, 60)` -> `(240, 200, 40)` -- more vivid warm yellow (raise R, raise G, lower B)
- Near rays: `(255, 230, 90)` -> `(255, 240, 60)` -- brighter warm yellow (raise G, lower B)

FogAnimation:
- Far blobs base (bright=False): `(160, 170, 180)` -> `(180, 190, 200)` -- slightly brighter grey
- Near blobs base (bright=True): `(200, 210, 220)` -> `(210, 220, 235)` -- slightly brighter blue-grey

ThunderAnimation:
- Inherits rain colors automatically through `self._rain = RainAnimation()` -- no direct changes needed
- Bolt color: Keep `(255, 255, 200, alpha)` -- warm white bolt is good
- Flash: Keep `(255, 255, 180, 120)` and `(200, 200, 150, 40)` -- these work well

**CRITICAL: Alpha preservation check.** After making changes, visually scan every `fill=(...)` in weather_anim.py and confirm the 4th value (alpha) is IDENTICAL to the original. This is a locked constraint from STATE.md.
  </action>
  <verify>
Run: `cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest tests/test_weather_anim.py -v`

All existing animation visibility tests must pass (alpha thresholds, pixel coverage, layer formats). These tests validate that the structural properties of animations are preserved.

Also verify no alpha values changed by inspecting the diff:
`git diff src/display/weather_anim.py` -- confirm only RGB channels changed, 4th tuple values (alpha) are identical.
  </verify>
  <done>
- COLOR_WEATHER_RAIN is `(255, 255, 255)` in layout.py
- All 6 animation classes in weather_anim.py have updated RGB values per the palette above
- All alpha values are unchanged from v1.0
- All existing test_weather_anim.py tests pass
- Comments on changed constants explain the rationale
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite to confirm no regressions</name>
  <files>src/display/layout.py, src/display/weather_anim.py</files>
  <action>
Run the complete test suite to confirm no regressions from the color changes.

The main risk areas:
1. `test_weather_anim.py` -- alpha thresholds and pixel coverage (should all pass since alphas unchanged)
2. `test_renderer.py` -- renderer tests may check for specific pixel colors or text rendering behavior. The COLOR_WEATHER_RAIN change from blue to white could affect pixel color assertions.

If any test in test_renderer.py fails because it expected the old blue rain color `(50, 180, 255)`:
- Update the test expectation to match the new white color `(255, 255, 255)`
- This is expected -- the test is correctly detecting the intentional color change

If any test fails for reasons unrelated to the intentional color changes, investigate and fix WITHOUT changing source behavior.

Do NOT change any alpha thresholds in test_weather_anim.py.
  </action>
  <verify>
Run: `cd /Users/jdl/Documents/GitHub/divoom-hub && python -m pytest -v`

ALL tests must pass with 0 failures.
  </verify>
  <done>
- Full test suite passes (all ~96+ tests)
- Any test expectations updated to match intentional color changes are documented
- No behavioral regressions (only color value changes)
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- all tests pass
2. `git diff src/display/layout.py` -- COLOR_WEATHER_RAIN is white, other text colors updated
3. `git diff src/display/weather_anim.py` -- RGB values changed, ALL alpha values identical to original
4. No new files created, no structural changes to rendering pipeline
</verification>

<success_criteria>
- Rain text is white (255, 255, 255) -- visually distinct from all animation particle colors
- All 8 animation types have vivid, saturated particle colors with clear hue separation
- Alpha values are byte-for-byte identical to v1.0
- Full test suite passes with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/07-weather-color-fix/07-01-SUMMARY.md`
</output>
