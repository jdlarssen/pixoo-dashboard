---
phase: 04-polish-and-reliability
plan: 03
type: execute
wave: 2
depends_on: [04-02]
files_modified:
  - src/config.py
  - src/display/state.py
  - src/display/renderer.py
  - src/display/layout.py
  - src/main.py
  - src/providers/discord_bot.py
  - requirements.txt
autonomous: false
requirements: [MSG-01]
user_setup:
  - service: discord
    why: "Message override via Discord bot"
    env_vars:
      - name: DISCORD_BOT_TOKEN
        source: "Discord Developer Portal -> Applications -> Bot -> Token"
      - name: DISCORD_CHANNEL_ID
        source: "Discord: Right-click channel -> Copy Channel ID (enable Developer Mode in settings)"
    dashboard_config:
      - task: "Create Discord application and bot"
        location: "https://discord.com/developers/applications -> New Application -> Bot"
      - task: "Enable Message Content Intent"
        location: "Discord Developer Portal -> Bot settings -> Privileged Gateway Intents -> Message Content Intent"
      - task: "Invite bot to server"
        location: "Discord Developer Portal -> OAuth2 -> URL Generator -> Select 'bot' scope, 'Read Messages' + 'Send Messages' permissions"
must_haves:
  truths:
    - "A Discord message sent in the configured channel appears on the Pixoo display"
    - "The message persists on display until cleared or replaced"
    - "Sending 'clear' in Discord removes the message from the display"
    - "Sending a new message replaces the old one"
    - "The message displays alongside existing dashboard content (not full-screen takeover)"
    - "If Discord bot is not configured (no token), the dashboard runs normally without it"
    - "The dashboard rendering loop is not blocked by the Discord bot"
  artifacts:
    - path: "src/providers/discord_bot.py"
      provides: "Discord bot running in background thread with MessageBridge"
    - path: "src/display/renderer.py"
      provides: "Message overlay rendering in weather zone"
    - path: "src/display/state.py"
      provides: "DisplayState with message_text field"
    - path: "src/main.py"
      provides: "Discord bot thread startup and message state integration"
  key_links:
    - from: "src/providers/discord_bot.py"
      to: "src/main.py"
      via: "MessageBridge shared object with thread-safe message state"
      pattern: "MessageBridge|bridge\\.current_message"
    - from: "src/main.py"
      to: "src/display/state.py"
      via: "message_text passed into DisplayState.from_now()"
      pattern: "message_text|bridge"
    - from: "src/display/renderer.py"
      to: "src/display/state.py"
      via: "Reads message_text to render overlay"
      pattern: "state\\.message_text"
---

<objective>
Add Discord bot integration for pushing persistent text messages to the display.

Purpose: The user wants to send reminders from their phone (via Discord) that appear on the Pixoo display alongside the normal dashboard content. Messages like "Remember a bag for shopping" stay visible until explicitly cleared. This plan adds a Discord bot running in a background thread, a thread-safe message bridge, and message rendering in the weather zone.

Output: New discord_bot.py provider, message state in DisplayState, message overlay rendering, background thread integration in main loop.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-and-reliability/04-RESEARCH.md
@.planning/phases/04-polish-and-reliability/04-CONTEXT.md
@.planning/phases/04-polish-and-reliability/04-02-SUMMARY.md
@src/config.py
@src/display/state.py
@src/display/renderer.py
@src/display/layout.py
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Discord bot provider with MessageBridge</name>
  <files>src/providers/discord_bot.py, src/config.py, requirements.txt</files>
  <action>
  1. Add `discord.py` to `requirements.txt` (or create it if missing):
     ```
     discord.py>=2.0
     ```
     Run `pip install discord.py` in the project venv.

  2. In `src/config.py`, add Discord configuration:
     ```python
     DISCORD_BOT_TOKEN = os.environ.get("DISCORD_BOT_TOKEN")  # None if not configured
     DISCORD_CHANNEL_ID = os.environ.get("DISCORD_CHANNEL_ID")  # None if not configured
     ```
     No default values -- Discord is optional. If both are None, the bot simply doesn't start.

  3. Create `src/providers/discord_bot.py` with:

     **MessageBridge class** -- thread-safe shared state between Discord bot thread and main loop:
     ```python
     import threading

     class MessageBridge:
         """Thread-safe bridge for passing messages from Discord bot to main loop."""
         def __init__(self):
             self._lock = threading.Lock()
             self._message: str | None = None

         def set_message(self, text: str | None) -> None:
             with self._lock:
                 self._message = text

         @property
         def current_message(self) -> str | None:
             with self._lock:
                 return self._message
     ```

     **run_discord_bot function** -- runs the bot (blocking, designed for background thread):
     ```python
     def run_discord_bot(bridge: MessageBridge, token: str, channel_id: int) -> None:
         import discord
         intents = discord.Intents.default()
         intents.message_content = True
         client = discord.Client(intents=intents)

         @client.event
         async def on_ready():
             logger.info("Discord bot connected as %s", client.user)

         @client.event
         async def on_message(message):
             # Ignore messages from other channels
             if message.channel.id != channel_id:
                 return
             # Ignore own messages
             if message.author == client.user:
                 return

             content = message.content.strip()
             if content.lower() in ("clear", "cls", "reset"):
                 bridge.set_message(None)
                 logger.info("Display message cleared via Discord")
                 # React to confirm
                 try:
                     await message.add_reaction("✓")
                 except Exception:
                     pass
             else:
                 bridge.set_message(content)
                 logger.info("Display message set: %s", content[:50])
                 try:
                     await message.add_reaction("✓")
                 except Exception:
                     pass

         client.run(token, log_handler=None)  # Suppress discord.py's own logging setup
     ```

     **start_discord_bot function** -- non-blocking, starts bot in daemon thread:
     ```python
     def start_discord_bot(token: str, channel_id: int) -> MessageBridge | None:
         """Start Discord bot in background thread. Returns MessageBridge or None if config missing."""
         if not token or not channel_id:
             return None

         bridge = MessageBridge()
         thread = threading.Thread(
             target=run_discord_bot,
             args=(bridge, token, int(channel_id)),
             daemon=True,  # Dies with main process
             name="discord-bot",
         )
         thread.start()
         return bridge
     ```

  The bot adds a checkmark reaction to messages to confirm receipt. The daemon thread ensures the bot dies when the main process exits.
  </action>
  <verify>
  1. Verify `src/providers/discord_bot.py` exists with MessageBridge, run_discord_bot, start_discord_bot
  2. Verify discord.py is installed: `python -c "import discord; print(discord.__version__)"`
  3. Verify DISCORD_BOT_TOKEN and DISCORD_CHANNEL_ID in config.py
  </verify>
  <done>Discord bot provider created with thread-safe MessageBridge, background thread startup, and clear/set message commands. Bot is optional -- gracefully absent when token not configured.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate message display into dashboard rendering</name>
  <files>src/display/state.py, src/display/layout.py, src/display/renderer.py, src/main.py</files>
  <action>
  1. In `src/display/state.py`, add message field to DisplayState:
     ```python
     message_text: str | None = None  # Persistent message from Discord bot
     ```
     Update `from_now()` to accept optional `message_text` parameter.

  2. In `src/display/layout.py`, add message color:
     ```python
     COLOR_MESSAGE = (255, 220, 100)  # Warm yellow for message text -- stands out
     ```

  3. In `src/display/renderer.py`, add message rendering to the weather zone.

     The user wants messages alongside existing content (not full-screen takeover). On the 64x64 display with the rebalanced weather zone (24px high from plan 04-02), use the bottom portion of the weather zone for the message:

     - When `state.message_text` is not None:
       - Use the bottom ~10px of the weather zone for the message
       - Draw message text in `COLOR_MESSAGE` using `fonts["tiny"]` (4x6 font)
       - Truncate text to fit within 64px width (approximately 15 characters with 4x6 font)
       - For longer messages, show first line that fits, with "..." truncation
       - The existing weather data (temperature, high/low, rain) renders in the top portion of the weather zone as normal
       - If weather zone space is too tight (message collides with weather text), push rain indicator text up or hide it in favor of the message

     - When `state.message_text` is None:
       - Render weather zone normally (no change from current behavior)

     This keeps the message compact and alongside content. On a 64x64 LED, ~15 characters in 4x6 font is readable at arm's length.

  4. In `src/main.py`, integrate the Discord bot:
     ```python
     from src.providers.discord_bot import start_discord_bot
     from src.config import DISCORD_BOT_TOKEN, DISCORD_CHANNEL_ID

     # In main(), before starting the main loop:
     message_bridge = start_discord_bot(DISCORD_BOT_TOKEN, DISCORD_CHANNEL_ID)
     if message_bridge:
         logger.info("Discord bot started for message override")
     else:
         logger.info("Discord bot not configured (no DISCORD_BOT_TOKEN/DISCORD_CHANNEL_ID)")
     ```

     In main_loop, accept `message_bridge` parameter:
     ```python
     def main_loop(client, fonts, *, save_frame=False, message_bridge=None):
     ```

     Inside the loop, read current message from bridge:
     ```python
     current_message = message_bridge.current_message if message_bridge else None
     ```

     Pass to DisplayState:
     ```python
     current_state = DisplayState.from_now(now, bus_data=bus_data, weather_data=weather_data, message_text=current_message)
     ```

     The message_text change triggers a state change via equality comparison, so the display updates when a message arrives or is cleared.
  </action>
  <verify>
  1. Run `python src/main.py --simulated --save-frame` (without Discord token) -- should run normally, log "Discord bot not configured"
  2. Set DISCORD_BOT_TOKEN and DISCORD_CHANNEL_ID env vars, run again -- should log "Discord bot started"
  3. Send a message in the configured Discord channel -- should appear on display
  4. Send "clear" -- message should disappear
  5. Verify the message renders in the weather zone alongside weather data
  </verify>
  <done>Discord messages display on the Pixoo alongside normal dashboard content. Messages persist until cleared. Bot runs in background thread without blocking rendering. Dashboard works normally when Discord is not configured.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Set up Discord bot application</name>
  <what-built>Discord bot integration -- bot code is ready but needs a Discord application and bot token to function.</what-built>
  <how-to-verify>
  1. Go to https://discord.com/developers/applications
  2. Click "New Application", name it "Divoom Hub" (or any name)
  3. Go to "Bot" in the sidebar, click "Reset Token" to get your bot token
  4. Under "Privileged Gateway Intents", enable "Message Content Intent"
  5. Go to "OAuth2" -> "URL Generator":
     - Select scope: "bot"
     - Select permissions: "Read Messages/View Channels", "Send Messages", "Add Reactions"
     - Copy the generated URL and open it to invite the bot to your Discord server
  6. Create a channel (e.g., "#pixoo-display") for sending messages
  7. Right-click the channel -> "Copy Channel ID" (enable Developer Mode in Discord Settings -> Advanced first)
  8. Set environment variables:
     ```bash
     export DISCORD_BOT_TOKEN="your-token-here"
     export DISCORD_CHANNEL_ID="your-channel-id-here"
     ```
  9. Run `python src/main.py --simulated` and send a test message in the channel
  10. Verify the message appears on the simulated display and bot reacts with checkmark
  </how-to-verify>
  <resume-signal>Type "approved" when Discord bot is working, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Discord bot runs in background thread without blocking main loop
- [ ] Messages from configured channel appear on display
- [ ] "clear" command removes message
- [ ] New message replaces old message
- [ ] Message renders alongside weather data (not full-screen takeover)
- [ ] Dashboard runs normally when Discord is not configured
- [ ] Bot reacts with checkmark to confirm receipt
- [ ] DisplayState equality detects message changes (dirty flag works)
</verification>

<success_criteria>
A text message can be pushed via Discord to temporarily override/augment the normal display. Messages are persistent reminders that stay until cleared or replaced.
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-and-reliability/04-03-SUMMARY.md`
</output>
