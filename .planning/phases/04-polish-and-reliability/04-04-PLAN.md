---
phase: 04-polish-and-reliability
plan: 04
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - src/display/renderer.py
  - src/display/layout.py
  - src/display/state.py
  - com.divoom-hub.dashboard.plist
autonomous: false
requirements: [RLBL-03]
must_haves:
  truths:
    - "The service restarts automatically after a crash"
    - "The service starts automatically on user login"
    - "A launchd plist file exists and can be loaded"
    - "March 17 and December 16 show a birthday easter egg on the display"
    - "The birthday display adds festive touches without replacing the dashboard"
  artifacts:
    - path: "com.divoom-hub.dashboard.plist"
      provides: "macOS launchd service definition with KeepAlive"
    - path: "src/display/renderer.py"
      provides: "Birthday easter egg rendering for March 17 and December 16"
    - path: "src/display/layout.py"
      provides: "Birthday color constants"
  key_links:
    - from: "com.divoom-hub.dashboard.plist"
      to: "src/main.py"
      via: "ProgramArguments references Python interpreter and main.py"
      pattern: "ProgramArguments|main.py"
    - from: "src/display/renderer.py"
      to: "src/display/state.py"
      via: "Birthday detection based on current date"
      pattern: "is_birthday|birthday"
---

<objective>
Add launchd service wrapper for auto-restart and a birthday easter egg for special dates.

Purpose: The service wrapper ensures the dashboard runs reliably as a daily-use appliance -- auto-starting on login and restarting on crash. The birthday easter egg adds a fun surprise on March 17 and December 16 per the user's request.

Output: launchd plist file for macOS service supervision, birthday detection and rendering in the display.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-and-reliability/04-RESEARCH.md
@.planning/phases/04-polish-and-reliability/04-CONTEXT.md
@.planning/phases/04-polish-and-reliability/04-01-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-02-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-03-SUMMARY.md
@src/display/renderer.py
@src/display/layout.py
@src/display/state.py
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create launchd plist for auto-restart service</name>
  <files>com.divoom-hub.dashboard.plist</files>
  <action>
  Create a macOS launchd plist file at the project root: `com.divoom-hub.dashboard.plist`

  The plist should:
  - Label: `com.divoom-hub.dashboard`
  - ProgramArguments: Full path to the venv Python interpreter and src/main.py with --ip flag
    - Use placeholder paths that the user can customize: `/EDIT/PATH/TO/divoom-hub/.venv/bin/python` and `/EDIT/PATH/TO/divoom-hub/src/main.py`
  - WorkingDirectory: Project root (placeholder path)
  - KeepAlive with SuccessfulExit=false: Restart on crash (non-zero exit), but not on clean shutdown (Ctrl+C / exit 0)
  - StandardOutPath: `/tmp/divoom-hub.log`
  - StandardErrorPath: `/tmp/divoom-hub.err`
  - EnvironmentVariables dict with placeholders for:
    - DIVOOM_IP (device IP)
    - DISCORD_BOT_TOKEN (optional)
    - DISCORD_CHANNEL_ID (optional)
  - RunAtLoad: true (start when the plist is loaded / user logs in)

  Add a comment block at the top of the file (as XML comment) with installation instructions:
  ```
  <!-- Installation:
    1. Edit paths below to match your system
    2. Copy to LaunchAgents: cp com.divoom-hub.dashboard.plist ~/Library/LaunchAgents/
    3. Load: launchctl load ~/Library/LaunchAgents/com.divoom-hub.dashboard.plist
    4. Check status: launchctl list | grep divoom
    5. Stop: launchctl unload ~/Library/LaunchAgents/com.divoom-hub.dashboard.plist
    6. View logs: tail -f /tmp/divoom-hub.log
  -->
  ```
  </action>
  <verify>
  1. Verify plist file exists at project root
  2. Validate XML: `plutil -lint com.divoom-hub.dashboard.plist`
  3. Check KeepAlive, RunAtLoad, EnvironmentVariables keys are present
  </verify>
  <done>A valid launchd plist exists that can be installed to auto-start and auto-restart the dashboard service on macOS.</done>
</task>

<task type="auto">
  <name>Task 2: Add birthday easter egg for March 17 and December 16</name>
  <files>src/display/state.py, src/display/layout.py, src/display/renderer.py</files>
  <action>
  1. In `src/display/state.py`, add birthday detection:
     ```python
     is_birthday: bool = False  # True on March 17 or December 16
     ```
     In `from_now()`, set based on date:
     ```python
     is_birthday = (dt.month == 3 and dt.day == 17) or (dt.month == 12 and dt.day == 16)
     ```

  2. In `src/display/layout.py`, add birthday colors:
     ```python
     COLOR_BIRTHDAY_GOLD = (255, 200, 50)     # Golden festive color
     COLOR_BIRTHDAY_CROWN = (255, 215, 0)     # Crown/star color
     COLOR_BIRTHDAY_ACCENT = (255, 100, 150)  # Pink accent
     ```

  3. In `src/display/renderer.py`, add birthday rendering that activates when `state.is_birthday`:

     **Crown/star icon in top-right corner:**
     - Draw a small 5x5 pixel crown icon at position (58, 0) -- top-right of clock zone
     - Crown design: 3 points using COLOR_BIRTHDAY_CROWN pixels
       ```
       Simple crown pattern (5x5):
       . * . * .
       . * * * .
       * * * * *
       * * * * *
       * . . . *
       ```
     - Draw using individual pixel plotting (draw.point)

     **Festive text color override:**
     - When `is_birthday`, override `COLOR_TIME` with `COLOR_BIRTHDAY_GOLD` for the clock digits
     - Override `COLOR_DATE` with `COLOR_BIRTHDAY_ACCENT` for the date text
     - This gives a warm, festive glow to the clock/date without changing the overall layout

     **Subtle sparkle:**
     - Add 2-3 small "sparkle" pixels (single bright white or gold pixels) at random-ish positions in the clock zone border area. Use deterministic positions (not random each frame) to avoid flicker -- e.g., positions based on `hash(state.date_str) % N`.

     The birthday treatment should be a fun surprise, not a dramatic takeover. The dashboard remains fully functional with all zones visible.
  </action>
  <verify>
  1. Temporarily set the date check to today's date and run `python src/main.py --simulated --save-frame`
  2. Verify crown icon appears in top-right
  3. Verify clock text is golden and date text is pink
  4. Verify sparkle pixels are visible
  5. Revert the date check to March 17 / December 16
  6. Run without birthday date -- verify normal rendering, no crown/sparkles
  </verify>
  <done>Birthday easter egg shows a crown icon, golden clock text, pink date text, and sparkle accents on March 17 and December 16. Normal display on all other days.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 4 dashboard</name>
  <what-built>Complete Phase 4: urgency-colored bus departures, auto-brightness, visual color overhaul, Discord message override, staleness indicators, launchd service wrapper, and birthday easter egg.</what-built>
  <how-to-verify>
  1. Run `python src/main.py --simulated --save-frame`
  2. Verify the display:
     - Clock is smaller and has warm color
     - Date has teal/cyan tint
     - Bus departures show urgency colors (green/yellow/red/dimmed based on time)
     - Weather zone has vivid animation colors (if applicable weather)
     - Overall display feels colorful and fun (not grey/monochrome)
  3. If Discord is configured: send a message, verify it shows on display alongside weather
  4. Send "clear" in Discord, verify message disappears
  5. Validate launchd plist: `plutil -lint com.divoom-hub.dashboard.plist`
  6. (Optional) Temporarily modify birthday check to today and verify festive display
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] launchd plist validates with plutil
- [ ] Plist has KeepAlive, RunAtLoad, EnvironmentVariables
- [ ] Installation instructions are clear in plist comments
- [ ] Birthday easter egg activates on March 17 and December 16
- [ ] Birthday adds crown icon, golden clock, pink date, sparkles
- [ ] Birthday does not break or hide any dashboard content
- [ ] Normal days show no birthday elements
- [ ] Full Phase 4 integration verified (all features work together)
</verification>

<success_criteria>
The service restarts automatically after a crash via launchd. Birthday easter egg adds a festive surprise on special dates. Full Phase 4 is production-ready for daily use.
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-and-reliability/04-04-SUMMARY.md`
</output>
