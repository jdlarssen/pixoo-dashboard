---
phase: 04-polish-and-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/display/layout.py
  - src/display/renderer.py
  - src/display/state.py
  - src/main.py
  - src/providers/bus.py
  - src/providers/weather.py
autonomous: true
requirements: [BUS-04, RLBL-02]
must_haves:
  truths:
    - "Bus departures >10 min show green countdown text"
    - "Bus departures 5-10 min show yellow countdown text"
    - "Bus departures <5 min show red countdown text"
    - "Bus departures <2 min show dimmed grey countdown text"
    - "When bus API fails, last known data still displays (not blank)"
    - "When weather API fails, last known data still displays (not blank)"
    - "Stale data older than threshold shows dash placeholders"
    - "A visual staleness indicator appears when data is stale but still usable"
  artifacts:
    - path: "src/display/renderer.py"
      provides: "Urgency color selection per departure, staleness indicator rendering"
    - path: "src/main.py"
      provides: "Staleness tracking with last-good data preservation"
    - path: "src/display/layout.py"
      provides: "Urgency and staleness color constants"
  key_links:
    - from: "src/main.py"
      to: "src/display/state.py"
      via: "Staleness metadata passed through DisplayState"
      pattern: "bus_stale|weather_stale|last_bus_fetch"
    - from: "src/display/renderer.py"
      to: "src/display/layout.py"
      via: "urgency_color function using threshold constants"
      pattern: "urgency_color|COLOR_URGENCY"
---

<objective>
Add bus departure urgency coloring and graceful error handling with staleness tracking.

Purpose: Bus countdowns are currently white -- urgency colors make them instantly actionable ("green = relax, red = run"). Error handling ensures the display never goes blank when APIs fail -- it shows the last known data with a staleness indicator, degrading gracefully to dash placeholders when data is too old.

Output: Modified renderer with per-departure urgency colors, staleness tracking in main loop preserving last-good data, and visual staleness indicators on the display.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-and-reliability/04-RESEARCH.md
@.planning/phases/04-polish-and-reliability/04-CONTEXT.md
@src/display/renderer.py
@src/display/layout.py
@src/display/state.py
@src/main.py
@src/providers/bus.py
@src/providers/weather.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add urgency color system for bus departures</name>
  <files>src/display/layout.py, src/display/renderer.py</files>
  <action>
  1. In `src/display/layout.py`, add urgency color constants:
     - `COLOR_URGENCY_GREEN = (50, 255, 50)` -- >10 min, plenty of time
     - `COLOR_URGENCY_YELLOW = (255, 200, 0)` -- 5-10 min, hurry
     - `COLOR_URGENCY_RED = (255, 50, 50)` -- <5 min, imminent
     - `COLOR_URGENCY_DIMMED = (80, 80, 80)` -- <2 min, bus has effectively left

  2. In `src/display/layout.py`, add a helper function `urgency_color(minutes: int) -> tuple[int, int, int]` that returns the appropriate color based on thresholds:
     - `< 2` -> DIMMED
     - `< 5` -> RED
     - `<= 10` -> YELLOW
     - `> 10` -> GREEN

  3. In `src/display/renderer.py`, modify `_draw_bus_line()` to draw each departure countdown number individually with its own urgency color instead of drawing all numbers as a single string with `COLOR_BUS_TIME`.

  For each departure minute value in the `departures` tuple:
  - Call `urgency_color(minutes)` to get the color
  - Draw each number at the correct x position (incrementing by character width + spacing)
  - When `departures is None`, still use `COLOR_PLACEHOLDER` for "--" dashes

  The direction label (`<S`, `>L`) retains its existing color (`COLOR_BUS_DIR1`/`COLOR_BUS_DIR2`) -- user said color applies to countdown text only.
  </action>
  <verify>
  Run `python src/main.py --simulated --save-frame` and inspect `debug_frame.png`:
  - Bus departures with different minute values should show different colors
  - Direction labels should remain their original blue/amber colors
  - Placeholder dashes should remain dim grey
  </verify>
  <done>Each bus departure number renders in its urgency color (green/yellow/red/dimmed) based on the minute value. Direction labels unchanged. Placeholders dim grey.</done>
</task>

<task type="auto">
  <name>Task 2: Add staleness tracking and graceful error states</name>
  <files>src/display/state.py, src/display/layout.py, src/display/renderer.py, src/main.py</files>
  <action>
  1. In `src/display/state.py`, add staleness fields to `DisplayState`:
     - `bus_stale: bool = False` -- True when bus data is stale (>180s old) but still usable
     - `bus_too_old: bool = False` -- True when bus data is too old (>600s), show dashes
     - `weather_stale: bool = False` -- True when weather data is stale (>1800s old) but still usable
     - `weather_too_old: bool = False` -- True when weather data is too old (>3600s), show dashes

  2. In `src/main.py`, refactor the data flow to preserve last-good data on fetch failure:
     - Track `last_bus_data` and `last_bus_fetch_time` (monotonic). When `fetch_bus_data()` returns `(None, None)`, keep using `last_bus_data` (the previous successful result).
     - Same pattern for weather: track `last_weather_data` and `last_weather_fetch_time`.
     - Calculate staleness: compare current `time.monotonic()` against last successful fetch time.
     - Bus thresholds: stale after 180s (3 min), too_old after 600s (10 min).
     - Weather thresholds: stale after 1800s (30 min), too_old after 3600s (1 hour).
     - Pass `bus_stale`, `bus_too_old`, `weather_stale`, `weather_too_old` into `DisplayState.from_now()`.
     - When `too_old` is True, pass None for the data so the display shows dashes.

  3. Update `DisplayState.from_now()` to accept and store staleness flags as keyword arguments.

  4. In `src/display/layout.py`, add staleness indicator color:
     - `COLOR_STALE_INDICATOR = (255, 100, 0)` -- orange dot for stale data

  5. In `src/display/renderer.py`:
     - When `state.bus_stale` is True (but not too_old), draw a small orange dot (1x1 pixel) at top-right of bus zone as staleness indicator.
     - When `state.weather_stale` is True, draw a small orange dot at top-right of weather zone.
     - The dot is subtle but noticeable -- signals "data may be outdated".

  Keep the existing `_safe` wrapper pattern in providers -- they still catch exceptions and return None. The main loop now interprets None as "keep using last data" instead of "show nothing".
  </action>
  <verify>
  1. Run `python src/main.py --simulated --save-frame` -- should work normally
  2. Verify staleness fields are in DisplayState
  3. Check that last-good data is preserved when a fetch returns None (review code logic)
  4. The staleness indicator dot should render when stale flags are set
  </verify>
  <done>Bus and weather data persist through API failures using last-good values. Staleness tracked via monotonic timestamps. Orange indicator dot shows when data is stale. Dash placeholders appear when data is too old.</done>
</task>

</tasks>

<verification>
- [ ] Bus departure countdown numbers render in urgency colors (green >10, yellow 5-10, red <5, dimmed <2)
- [ ] Direction labels remain their original colors (blue/amber)
- [ ] API failure does not blank the display -- last-good data shown
- [ ] Stale data shows orange indicator dot
- [ ] Data older than threshold shows dash placeholders
- [ ] All existing tests pass
- [ ] Simulator mode works with urgency colors visible
</verification>

<success_criteria>
Bus departures are color-coded by urgency and the display handles API failures gracefully with staleness indicators, never going blank.
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-and-reliability/04-01-SUMMARY.md`
</output>
