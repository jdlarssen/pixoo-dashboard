---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/providers/clock.py
  - src/display/state.py
  - src/display/layout.py
  - src/display/renderer.py
  - src/main.py
  - tests/test_clock.py
  - tests/test_renderer.py
autonomous: false
requirements:
  - DISP-03
  - CLCK-01
  - CLCK-02

must_haves:
  truths:
    - "Current time is displayed in large, readable digits on the Pixoo 64"
    - "Today's date appears in Norwegian format with correct aeoeaa characters"
    - "All three information zones (clock, bus placeholder, weather placeholder) are visible on the 64x64 layout"
    - "The display updates every minute when the clock changes and runs continuously without lockup"
  artifacts:
    - path: "src/providers/clock.py"
      provides: "Norwegian date formatting with manual dictionaries"
      exports: ["format_date_norwegian", "format_time"]
    - path: "src/display/state.py"
      provides: "DisplayState dataclass holding current render data"
      exports: ["DisplayState"]
    - path: "src/display/layout.py"
      provides: "Zone definitions with pixel coordinates for clock, bus, weather zones"
      exports: ["ZONES", "CLOCK_ZONE", "DATE_ZONE", "BUS_ZONE", "WEATHER_ZONE"]
    - path: "src/display/renderer.py"
      provides: "PIL compositor that renders DisplayState into a 64x64 image"
      exports: ["render_frame"]
    - path: "src/main.py"
      provides: "Entry point with main loop, dirty flag, frame push"
      contains: "main_loop"
  key_links:
    - from: "src/main.py"
      to: "src/display/renderer.py"
      via: "render_frame(state, fonts, layout) call"
      pattern: "render_frame"
    - from: "src/main.py"
      to: "src/device/pixoo_client.py"
      via: "client.push_frame(image) call"
      pattern: "push_frame"
    - from: "src/display/renderer.py"
      to: "src/display/fonts.py"
      via: "fonts dict passed to render_frame"
      pattern: "fonts\\[.large|small|tiny.\\]"
    - from: "src/providers/clock.py"
      to: "src/display/state.py"
      via: "Clock provider populates DisplayState fields"
      pattern: "DisplayState"
---

<objective>
Build the complete rendering pipeline: Norwegian clock/date provider, zone-based 64x64 layout, PIL frame compositor, and the main loop that pushes updated frames to the Pixoo 64. This plan produces the running dashboard showing time and date with placeholder zones for bus and weather data.

Purpose: Deliver the first visible, working dashboard on the physical device. The user should see current time in large digits, today's date in Norwegian, and clearly defined zones for future bus and weather data.

Output: A running `main.py` that displays the clock dashboard on the Pixoo 64, verified by the user on the physical device.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Norwegian clock provider and display state</name>
  <files>
    src/providers/clock.py
    src/display/state.py
    tests/test_clock.py
  </files>
  <action>
Create the clock data provider and the display state model.

1. Create `src/providers/clock.py`:
   - Norwegian day abbreviations dict (from research):
     ```python
     DAYS_NO = ["man", "tir", "ons", "tor", "fre", "lor", "son"]
     ```
     IMPORTANT: "lor" (Saturday) contains oe (U+00F8). Use the actual Unicode character, not ASCII approximation. Write it as `"l\u00f8r"` or use the literal oe character if the file encoding is UTF-8.
     Similarly "son" (Sunday) is actually "son" with oe: `"s\u00f8n"`. Verify: mandag, tirsdag, onsdag, torsdag, fredag, lordag (oe), sondag (oe). Abbreviated: man, tir, ons, tor, fre, lor (oe), son (oe).
   - Norwegian month abbreviations:
     ```python
     MONTHS_NO = ["jan", "feb", "mar", "apr", "mai", "jun", "jul", "aug", "sep", "okt", "nov", "des"]
     ```
     None of the abbreviated month names contain special characters.
   - `format_time(dt: datetime) -> str`: Returns "HH:MM" in 24-hour format using `dt.strftime("%H:%M")`.
   - `format_date_norwegian(dt: datetime) -> str`: Returns "tor 20. feb" style string using the dictionaries. Format: `f"{day_name} {dt.day}. {month_name}"`.

2. Create `src/display/state.py`:
   - `DisplayState` dataclass with fields:
     - `time_str: str` (e.g., "14:32")
     - `date_str: str` (e.g., "tor 20. feb")
   - Implement `__eq__` via dataclass (default). This enables the dirty flag pattern -- only re-render when state changes.
   - Factory method `DisplayState.from_now(dt: datetime) -> DisplayState` that creates a state from current time using the clock provider functions.

3. Create `tests/test_clock.py`:
   - Test `format_time` returns "09:05" for 9:05 AM, "14:32" for 2:32 PM, "00:00" for midnight.
   - Test `format_date_norwegian` for several dates:
     - Thursday Feb 20, 2026 -> "tor 20. feb"
     - Saturday March 21, 2026 -> "lor 21. mar" (MUST contain oe character)
     - Sunday January 1, 2026 -> "son 1. jan" (MUST contain oe character)
     - Wednesday December 31, 2025 -> "ons 31. des"
   - Test that "lor" and "son" actually contain the Unicode oe character (U+00F8), not ASCII 'o'.
   - Test `DisplayState.__eq__`: same time/date = equal, different minute = not equal.
  </action>
  <verify>
    - `source .venv/bin/activate && python -m pytest tests/test_clock.py -v` passes all tests
    - The Saturday test confirms the oe character is present (not ASCII 'o')
    - `ruff check src/providers/clock.py src/display/state.py` passes
  </verify>
  <done>Norwegian clock provider formats time (24h) and date (with real oe in "lor"/"son"). DisplayState dataclass supports equality comparison for dirty flag. All clock formatting tests pass including explicit Unicode verification.</done>
</task>

<task type="auto">
  <name>Task 2: Zone layout, PIL renderer, and main loop</name>
  <files>
    src/display/layout.py
    src/display/renderer.py
    src/main.py
    tests/test_renderer.py
  </files>
  <action>
Build the visual rendering pipeline and the application entry point.

1. Create `src/display/layout.py`:
   Define zone coordinates based on the pixel budget from research:
   ```
   CLOCK_ZONE:   y=0,  height=14  (7x13 font + 1px padding)
   DATE_ZONE:    y=14, height=9   (5x8 font + 1px padding)
   DIVIDER_1:    y=23, height=1   (1px line)
   BUS_ZONE:     y=24, height=19  (placeholder for Phase 2)
   DIVIDER_2:    y=43, height=1   (1px line)
   WEATHER_ZONE: y=44, height=20  (placeholder for Phase 3)
   Total: 14+9+1+19+1+20 = 64px
   ```
   Each zone as a dataclass or namedtuple with fields: `name, x, y, width, height`.
   - `ZONES` dict mapping zone name to zone definition.
   - Color constants:
     - `COLOR_TIME = (255, 255, 255)` -- bright white for clock
     - `COLOR_DATE = (180, 180, 180)` -- dim white for date
     - `COLOR_DIVIDER = (40, 40, 40)` -- subtle gray divider
     - `COLOR_PLACEHOLDER = (60, 60, 60)` -- very dim for placeholder text
   - Text x-offset: `TEXT_X = 2` (2px left padding for all text)

2. Create `src/display/renderer.py`:
   - `render_frame(state: DisplayState, fonts: dict) -> Image.Image`:
     - Creates `Image.new("RGB", (64, 64), color=(0, 0, 0))` -- black background
     - Gets `ImageDraw.Draw(img)`
     - Renders clock time at CLOCK_ZONE position using fonts["large"], COLOR_TIME
     - Renders date at DATE_ZONE position using fonts["small"], COLOR_DATE
     - Draws horizontal divider lines (1px) at DIVIDER_1 and DIVIDER_2 y-positions using `draw.line()` with COLOR_DIVIDER
     - Renders "BUS" placeholder text in BUS_ZONE using fonts["tiny"], COLOR_PLACEHOLDER
     - Renders "WEATHER" placeholder text (or Norwegian "VAER" -- use "V\u00c6R" with ae) in WEATHER_ZONE using fonts["tiny"], COLOR_PLACEHOLDER
     - Returns the composed PIL Image
   - Do NOT fetch any data inside this function. It only renders from the provided state.

3. Create `src/main.py`:
   - Parse command-line argument for device IP (override config default): `--ip` flag
   - Add `--simulated` flag for simulator mode (default: False)
   - Add `--save-frame` flag that saves each rendered frame to `debug_frame.png` in the project root (useful for development without hardware)
   - Main loop implementation (from research pattern):
     ```python
     def main_loop(client, fonts):
         last_state = None
         while True:
             now = datetime.now()
             current_state = DisplayState.from_now(now)
             if current_state != last_state:
                 frame = render_frame(current_state, fonts)
                 if save_frame_flag:
                     frame.save("debug_frame.png")
                 client.push_frame(frame)
                 last_state = current_state
             time.sleep(1)
     ```
   - Startup sequence:
     1. Load fonts via `load_fonts(FONT_DIR)`
     2. Initialize PixooClient with IP and simulated flag
     3. Set brightness to MAX_BRIGHTNESS
     4. Enter main loop
   - Wrap main loop in try/except KeyboardInterrupt for clean shutdown

4. Create `tests/test_renderer.py`:
   - Test that `render_frame()` returns a 64x64 RGB PIL Image
   - Test that the clock region (y=0 to y=13) contains non-black pixels (white text was drawn)
   - Test that the date region (y=14 to y=22) contains non-black pixels
   - Test that divider lines exist at y=23 and y=43 (check for non-black pixels along those rows)
   - Test that placeholder zones contain non-black pixels (text was rendered)
   - Save a test frame to `/tmp/test_dashboard.png` for visual inspection
   - These tests use actual loaded fonts from assets/fonts/ (integration test, not mocked)
  </action>
  <verify>
    - `source .venv/bin/activate && python -m pytest tests/test_renderer.py -v` passes all tests
    - `/tmp/test_dashboard.png` exists and shows a recognizable dashboard layout when opened
    - `source .venv/bin/activate && python -m pytest tests/ -v` runs ALL tests (clock + fonts + renderer) and passes
    - `ruff check src/` passes with no errors
    - `source .venv/bin/activate && python src/main.py --save-frame --simulated` runs without crashing and produces `debug_frame.png` (may need Ctrl+C after a few seconds since it's a loop)
  </verify>
  <done>The renderer produces a correct 64x64 dashboard image with clock, date, dividers, and placeholder zones. Main loop runs with dirty flag pattern, only pushing frames when the minute changes. All tests pass. debug_frame.png shows the complete layout.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify dashboard on physical Pixoo 64</name>
  <files>debug_frame.png</files>
  <action>
CHECKPOINT: Human verification of the physical Pixoo 64 dashboard.

What was built: Complete Phase 1 dashboard -- clock with large digits, Norwegian date (with aeoeaa), zone dividers, and labeled placeholder areas for bus and weather. The display updates every minute and uses connection refresh to prevent device lockup.

How to verify:

1. First check the rendered frame without hardware:
   - Open `debug_frame.png` (or `/tmp/test_dashboard.png`) in an image viewer
   - Verify: time digits are large and readable, date is in Norwegian format, three zones are clearly separated
   - If the frame looks wrong, describe what's off before proceeding to device

2. Find your Pixoo 64's IP address (check your router's DHCP table or use the Divoom app)

3. Run on the physical device:
   ```bash
   cd /Users/jdl/Documents/GitHub/divoom-hub
   source .venv/bin/activate
   python src/main.py --ip YOUR_PIXOO_IP
   ```

4. Verify on the physical Pixoo 64:
   - [ ] Time is displayed in large, readable digits (can you read it from 2+ meters?)
   - [ ] Date is in Norwegian format (e.g., "tor 20. feb")
   - [ ] If today is Saturday or Sunday, the oe character renders correctly in "lor"/"son"
   - [ ] Three zones are visible: clock/date at top, bus placeholder in middle, weather placeholder at bottom
   - [ ] Divider lines separate the zones
   - [ ] Display updates when the minute changes (wait for it or change system time)

5. Let it run for 5+ minutes to verify stability (no crashes, no frozen display)

6. Press Ctrl+C to stop

Resume signal: Type "approved" if the dashboard looks correct on the device, or describe any issues you see (layout problems, unreadable text, missing characters, etc.)
  </action>
  <verify>User confirms the dashboard displays correctly on the physical Pixoo 64 device.</verify>
  <done>Physical Pixoo 64 shows: readable time digits, Norwegian date with correct characters, three clearly separated zones, and stable continuous operation.</done>
</task>

</tasks>

<verification>
1. Clock provider: `python -m pytest tests/test_clock.py -v` -- Norwegian formatting with oe verified
2. Font system: `python -m pytest tests/test_fonts.py -v` -- all three fonts render aeoeaa
3. Renderer: `python -m pytest tests/test_renderer.py -v` -- 64x64 layout with all zones
4. Full suite: `python -m pytest tests/ -v` -- all tests pass
5. Visual: `debug_frame.png` shows complete dashboard layout
6. Device: Physical Pixoo 64 displays the dashboard (human verified)
7. Code quality: `ruff check src/` passes
</verification>

<success_criteria>
- Norwegian date formatting works with real Unicode aeoeaa characters
- 64x64 layout has three distinct zones: clock/date, bus placeholder, weather placeholder
- Renderer produces a visually correct dashboard frame
- Main loop pushes frames only when clock minute changes (dirty flag)
- Physical Pixoo 64 displays the dashboard readably from 2+ meters
- Display runs stably without lockup (connection refresh working)
- All tests pass, code is clean
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
