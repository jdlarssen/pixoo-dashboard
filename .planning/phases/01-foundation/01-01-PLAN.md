---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/__init__.py
  - src/config.py
  - src/device/__init__.py
  - src/device/pixoo_client.py
  - src/display/__init__.py
  - src/display/fonts.py
  - assets/fonts/4x6.bdf
  - assets/fonts/5x8.bdf
  - assets/fonts/7x13.bdf
autonomous: true
requirements:
  - DISP-01
  - DISP-02
  - RLBL-01

must_haves:
  truths:
    - "A PIL/Pillow 64x64 RGB image can be rendered and pushed to the Pixoo 64 device"
    - "BDF bitmap fonts are converted to PIL format and load successfully with Norwegian characters (aeoeaa)"
    - "Device connection refresh is enabled to prevent the 300-push lockup"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project definition with all dependencies (pixoo, Pillow, pytest, ruff)"
      contains: "pixoo"
    - path: "src/config.py"
      provides: "Configuration constants (device IP, display size, font paths, push interval)"
      contains: "DISPLAY_SIZE"
    - path: "src/device/pixoo_client.py"
      provides: "Pixoo device wrapper with connection refresh and frame push"
      exports: ["PixooClient"]
    - path: "src/display/fonts.py"
      provides: "BDF-to-PIL font conversion and font registry"
      exports: ["load_fonts", "convert_bdf_to_pil"]
    - path: "assets/fonts/7x13.bdf"
      provides: "Large bitmap font for clock digits"
    - path: "assets/fonts/5x8.bdf"
      provides: "Small bitmap font for date and labels"
  key_links:
    - from: "src/device/pixoo_client.py"
      to: "pixoo library"
      via: "Pixoo constructor with refresh_connection_automatically"
      pattern: "refresh_connection_automatically"
    - from: "src/display/fonts.py"
      to: "assets/fonts/*.bdf"
      via: "BdfFontFile conversion + ImageFont.load()"
      pattern: "BdfFontFile|ImageFont\\.load"
---

<objective>
Set up the Divoom Hub project infrastructure: Python project scaffolding with all dependencies, BDF bitmap font acquisition and conversion to PIL format with verified Norwegian character support, and the Pixoo 64 device communication wrapper with connection refresh enabled.

Purpose: Establish the rendering pipeline foundation -- fonts that can display Norwegian text and a device driver that can push frames indefinitely without lockup. Everything in Phase 1 builds on these primitives.

Output: Working project with installable dependencies, converted bitmap fonts verified to render aeoeaa, and a device client that can push a test frame to the Pixoo 64.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding and BDF font acquisition</name>
  <files>
    pyproject.toml
    src/__init__.py
    src/config.py
    src/device/__init__.py
    src/display/__init__.py
    src/providers/__init__.py
    assets/fonts/4x6.bdf
    assets/fonts/5x8.bdf
    assets/fonts/7x13.bdf
  </files>
  <action>
Create the Python project structure as defined in the research architecture:

1. Create `pyproject.toml` with:
   - Project name: divoom-hub
   - Python >= 3.10
   - Dependencies: pixoo (device communication), Pillow (image rendering)
   - Dev dependencies: pytest, ruff
   - A `[tool.ruff]` section with line-length=100

2. Create the source directory tree:
   - `src/__init__.py` (empty)
   - `src/device/__init__.py` (empty)
   - `src/display/__init__.py` (empty)
   - `src/providers/__init__.py` (empty)

3. Create `src/config.py` with constants:
   - `DEVICE_IP`: Read from environment variable `DIVOOM_IP` with fallback to `"192.168.1.100"`
   - `DISPLAY_SIZE`: 64
   - `PUSH_INTERVAL`: 1 (seconds between state checks)
   - `FONT_DIR`: Path to `assets/fonts/` relative to project root
   - `FONT_LARGE`: `"7x13"` (for clock digits)
   - `FONT_SMALL`: `"5x8"` (for date and labels)
   - `FONT_TINY`: `"4x6"` (for zone labels)
   - `MAX_BRIGHTNESS`: 90 (cap at 90% per research -- full brightness can crash device)

4. Download BDF fonts from hzeller/rpi-rgb-led-matrix:
   - `assets/fonts/4x6.bdf` from https://raw.githubusercontent.com/hzeller/rpi-rgb-led-matrix/master/fonts/4x6.bdf
   - `assets/fonts/5x8.bdf` from https://raw.githubusercontent.com/hzeller/rpi-rgb-led-matrix/master/fonts/5x8.bdf
   - `assets/fonts/7x13.bdf` from https://raw.githubusercontent.com/hzeller/rpi-rgb-led-matrix/master/fonts/7x13.bdf

5. Create Python virtual environment and install all dependencies:
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install pixoo Pillow pytest ruff
   ```

6. Create `.env.example` with `DIVOOM_IP=192.168.1.xxx` as a template. Add `.env` and `.venv/` to `.gitignore`.
  </action>
  <verify>
    - `ls pyproject.toml src/config.py assets/fonts/7x13.bdf assets/fonts/5x8.bdf assets/fonts/4x6.bdf` all exist
    - `.venv/bin/python -c "import pixoo; import PIL; print('OK')"` prints OK
    - `wc -l assets/fonts/7x13.bdf` returns a substantial file (>500 lines)
  </verify>
  <done>Project structure exists with all directories, config module loads, BDF font files are downloaded, and all Python dependencies are installed in the virtual environment.</done>
</task>

<task type="auto">
  <name>Task 2: BDF font conversion and Norwegian character verification</name>
  <files>
    src/display/fonts.py
    tests/test_fonts.py
  </files>
  <action>
Create the font loading system that converts BDF fonts to PIL format and verifies Norwegian character rendering.

1. Create `src/display/fonts.py` with:
   - `convert_bdf_to_pil(bdf_path: str, output_dir: str) -> str`: Converts a BDF font file to PIL format (.pil + .pbm files) using Pillow's `BdfFontFile` module. Returns the path to the .pil file.
   - `load_fonts(font_dir: str) -> dict[str, ImageFont.ImageFont]`: Loads all converted PIL fonts from the font directory. Returns a dict keyed by font name (e.g., "7x13", "5x8", "4x6"). Calls `convert_bdf_to_pil` for any BDF files that haven't been converted yet (checks for existing .pil file).
   - Uses `from PIL import BdfFontFile, ImageFont` for conversion and loading.
   - Font conversion pattern (from research):
     ```python
     with open(bdf_path, "rb") as fp:
         font = BdfFontFile.BdfFontFile(fp)
         font.save(pil_path_without_extension)
     ```
   - Font loading: `ImageFont.load(pil_path)` where pil_path ends in ".pil".

2. Create `tests/test_fonts.py` with:
   - Test that `load_fonts()` returns a dict with keys "7x13", "5x8", "4x6"
   - Test that each loaded font can render the string "14:32" without error (using `ImageDraw.text()` on a test image)
   - Test that each loaded font can render Norwegian characters: render the string "lør 21. mar" (contains oe at U+00F8) and "Å" (aa at U+00C5) and "blåbær" (contains both aa and ae) on a 64x64 test image. Save the test image to `/tmp/font_test.png` for visual inspection.
   - Test that the rendered text produces non-black pixels (i.e., the characters actually rendered, not silently skipped). Check by examining pixel data in the region where text was drawn.
   - Use `from PIL import Image, ImageDraw` for test rendering.

IMPORTANT: The Norwegian character test is the critical verification for DISP-02. If aeoeaa do not render, the entire font strategy needs to change. The test MUST explicitly check that pixels are non-black in the character regions.
  </action>
  <verify>
    - `source .venv/bin/activate && python -m pytest tests/test_fonts.py -v` passes all tests
    - `ls assets/fonts/7x13.pil assets/fonts/5x8.pil assets/fonts/4x6.pil` all exist (converted fonts)
    - `/tmp/font_test.png` exists and visually shows Norwegian characters when opened
  </verify>
  <done>BDF fonts are converted to PIL format. All three font sizes load successfully. Norwegian characters (aeoeaa) render as visible pixels -- verified by automated test checking non-black pixels in rendered regions.</done>
</task>

<task type="auto">
  <name>Task 3: Pixoo device client with connection refresh</name>
  <files>
    src/device/pixoo_client.py
  </files>
  <action>
Create the Pixoo 64 device communication wrapper.

1. Create `src/device/pixoo_client.py` with a `PixooClient` class:
   - Constructor takes `ip: str`, `size: int = 64`, `simulated: bool = False`
   - Initializes the pixoo library's `Pixoo` object:
     ```python
     from pixoo import Pixoo
     # For simulator mode:
     # from pixoo import Pixoo, SimulatorConfig
     ```
   - CRITICAL: Enable connection refresh to prevent 300-push lockup. The pixoo library handles this internally. Check the Pixoo constructor for a `refresh_connection_automatically` parameter. If it exists, set it to True. If the parameter name differs in v0.9.2, inspect the library source to find the correct parameter name. The research indicates this resets the internal counter every 32 frames.
   - `push_frame(image: Image.Image) -> None`: Takes a PIL Image, saves it to a temporary file (using `tempfile.NamedTemporaryFile`), calls `pixoo.draw_image(path)` then `pixoo.push()`. Enforces minimum 1-second interval between pushes using a timestamp check.
   - `set_brightness(level: int) -> None`: Calls `pixoo.set_brightness(level)`. Caps at MAX_BRIGHTNESS (90) from config.
   - Include a `test_connection() -> bool` method that pushes a solid-color test frame (e.g., dark blue 64x64 image) and returns True if no exception.

2. Add rate limiting: Track `_last_push_time` as an instance variable. In `push_frame()`, if less than 1 second has elapsed since last push, skip the push (log a warning but don't error).

3. Handle the simulator case: If `simulated=True`, initialize with `simulated=True` and `simulation_config=SimulatorConfig(4)` (4x scale). Note the Apple Silicon black screen issue from research -- the primary development verification should be saving frames as PNG, not relying on the simulator.

NOTE: The pixoo library uses CC-BY-NC-SA 4.0 license, which is fine for this personal project.
  </action>
  <verify>
    - `source .venv/bin/activate && python -c "from src.device.pixoo_client import PixooClient; print('import OK')"` succeeds
    - The file contains "refresh_connection" or equivalent connection refresh configuration
    - The file contains rate limiting logic (timestamp comparison before push)
    - `ruff check src/device/pixoo_client.py` passes with no errors
  </verify>
  <done>PixooClient class exists with connection refresh enabled, rate-limited frame pushing, brightness control capped at 90%, and simulator mode support. The wrapper abstracts the pixoo library so the rest of the codebase only interacts with PixooClient.</done>
</task>

</tasks>

<verification>
1. Project structure: `find src/ -name "*.py" | sort` shows all expected modules
2. Dependencies: `.venv/bin/python -c "import pixoo; from PIL import Image, ImageDraw, ImageFont, BdfFontFile; print('all imports OK')"` succeeds
3. Font pipeline: `ls assets/fonts/*.pil` shows 3 converted fonts (4x6.pil, 5x8.pil, 7x13.pil)
4. Norwegian rendering: `python -m pytest tests/test_fonts.py -v` passes, including aeoeaa character tests
5. Device client: `python -c "from src.device.pixoo_client import PixooClient"` imports without error
6. Code quality: `ruff check src/` passes
</verification>

<success_criteria>
- pyproject.toml defines the project with pixoo + Pillow dependencies
- Three BDF fonts (4x6, 5x8, 7x13) downloaded and converted to PIL format
- Norwegian characters (ae, oe, aa) render as visible pixels in all font sizes -- verified by automated tests
- PixooClient wrapper initializes with connection refresh, supports frame pushing with rate limiting
- All tests pass, all imports work, ruff reports no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
