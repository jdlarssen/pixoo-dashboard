---
phase: 08-norwegian-readme
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified: [README.md]
autonomous: true
requirements: [DOC-09, DOC-10, DOC-11, DOC-12, DOC-13, DOC-14, DOC-15]

must_haves:
  truths:
    - "A developer reading the architecture section understands the module structure, data flow, and rendering pipeline well enough to navigate the codebase"
    - "A developer understands how the Entur and MET Norway APIs are used, including their quirks and required headers"
    - "The Discord message override feature is documented with setup instructions and available commands"
    - "The weather animation system (3D depth layers, 8 types, compositing) is explained clearly enough to understand or modify"
    - "Norwegian character support via BDF fonts is documented"
    - "Error resilience (staleness dots, last-good-data, connection refresh, brightness cap) is documented"
    - "The birthday easter egg is mentioned with how to configure it"
  artifacts:
    - path: "README.md"
      provides: "Technical deep-dive sections: architecture, APIs, Discord, weather animations, Norwegian fonts, error resilience, birthday easter egg"
      min_lines: 350
  key_links:
    - from: "README.md (architecture section)"
      to: "src/ directory structure"
      via: "Module map matching actual file tree"
      pattern: "src/display|src/providers|src/device"
    - from: "README.md (API section)"
      to: "src/providers/bus.py, src/providers/weather.py"
      via: "API endpoint URLs and header requirements"
      pattern: "api.entur.io|api.met.no"
    - from: "README.md (animation section)"
      to: "src/display/weather_anim.py"
      via: "Animation type descriptions matching class names"
      pattern: "RainAnimation|SnowAnimation|ThunderAnimation"
---

<objective>
Add the technical deep-dive sections to README.md: architecture overview, API documentation, Discord message override, weather animations, Norwegian character support, error resilience, and birthday easter egg.

Purpose: Give a developer enough depth to understand the system internals, contribute, or fork -- while keeping the README scannable with collapsible sections.
Output: README.md with all 15 DOC requirements satisfied (DOC-09 through DOC-15 added to existing DOC-01-08 content).
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-norwegian-readme/08-CONTEXT.md
@.planning/phases/08-norwegian-readme/08-RESEARCH.md
@.planning/phases/08-norwegian-readme/08-01-SUMMARY.md

Source files for accurate documentation:
@src/config.py
@src/main.py
@src/device/pixoo_client.py
@src/display/layout.py
@src/display/renderer.py
@src/display/state.py
@src/display/fonts.py
@src/display/weather_anim.py
@src/display/weather_icons.py
@src/providers/bus.py
@src/providers/weather.py
@src/providers/discord_bot.py
@src/providers/clock.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add architecture overview and API documentation sections</name>
  <files>README.md</files>
  <action>
Append technical sections to the existing README.md (after the user-facing sections from plan 08-01).

**Arkitektur / Architecture Overview (DOC-09):**
- Module map showing the directory tree:
  ```
  src/
  ├── main.py           # Hovedloop og CLI
  ├── config.py          # Konfigurasjon (.env)
  ├── device/
  │   └── pixoo_client.py  # Pixoo 64-kommunikasjon
  ├── display/
  │   ├── fonts.py       # BDF-fontlasting
  │   ├── layout.py      # Sonedefinisjonar, fargar, piksler
  │   ├── renderer.py    # PIL-kompositor (state -> 64x64)
  │   ├── state.py       # DisplayState (dirty flag)
  │   ├── weather_anim.py  # 8 animasjonstypar med dybdelag
  │   └── weather_icons.py # Pikselkunst-vaerikon (10x10)
  └── providers/
      ├── bus.py         # Entur JourneyPlanner v3
      ├── clock.py       # Norsk tid/dato-formatering
      ├── discord_bot.py # Discord-meldingsoverstyring
      └── weather.py     # MET Norway Locationforecast 2.0
  ```
- Data flow diagram (text-based): main_loop -> providers (bus/weather/discord) -> DisplayState -> render_frame -> push_frame
- Explain the dirty flag pattern: DisplayState equality check, only re-render when state changes
- Explain the dual-speed main loop: 0.35s when animation active (~3 FPS), 1s when idle

**API-dokumentasjon / API Documentation (DOC-10):**

*Entur JourneyPlanner v3:*
- GraphQL endpoint: https://api.entur.io/journey-planner/v3/graphql
- Required header: ET-Client-Name
- Query pattern: estimatedCalls with quay ID, filtering cancelled departures
- Response: expectedDepartureTime, realtime flag, destination, line code
- Gotchas: Must request extra departures to compensate for cancelled ones being filtered out

*MET Norway Locationforecast 2.0:*
- REST endpoint: https://api.met.no/weatherapi/locationforecast/2.0/compact
- Required header: User-Agent (MET requires identification per TOS)
- If-Modified-Since caching: Module-level cache, returns 304 when data unchanged
- Response: timeseries with instant/next_1_hours/next_6_hours forecasts
- Gotchas: High/low calculated by scanning today's entries (not a single field), symbol_code has _day/_night suffixes that must be stripped for icon mapping
- API updates roughly every 10 minutes

Use `<details>` collapsible sections for the API deep-dives to keep the README scannable.
  </action>
  <verify>
- Architecture module map matches actual src/ directory structure exactly
- Data flow description matches the actual main_loop() implementation
- Entur API URL matches ENTUR_API_URL in config.py
- MET API URL matches WEATHER_API_URL in config.py
- API gotchas are accurate per the actual provider code
- All text in Norwegian bokmaal
  </verify>
  <done>Architecture overview and API documentation sections added with accurate technical details from source code</done>
</task>

<task type="auto">
  <name>Task 2: Add Discord, weather animations, Norwegian fonts, error resilience, and birthday sections</name>
  <files>README.md</files>
  <action>
Append remaining technical sections to README.md:

**Discord-meldingsoverstyring / Discord Message Override (DOC-11):**
- How it works: Discord bot runs in background daemon thread, listens on configured channel
- Thread-safe MessageBridge passes messages from async bot to sync main loop
- Available commands: any text sets display message, "clear"/"cls"/"reset" clears it
- Bot reacts with checkmark to confirm receipt
- Setup: create Discord bot, get token and channel ID, add to .env
- Message appears in bottom of weather zone (replaces rain indicator, keeps temperature visible)
- Optional feature: if not configured, bot simply doesn't start

**Vaeranimasjonar / Weather Animations (DOC-12):**
- 3D depth system overview:
  - Two RGBA layers per frame: bg_layer (behind text) and fg_layer (in front of text)
  - Alpha compositing creates depth effect: far particles dim behind text, near particles bright in front
- 8 animation types with brief descriptions:
  - Regn (Rain): Blue drops at two depths, near drops faster/brighter
  - Sno (Snow): + shaped crystals (near, bright) and single pixels (far, dim)
  - Sol (Sun): Diagonal warm yellow sunrays at two speeds
  - Skyer (Clouds): Drifting grey-white ellipse blobs
  - Torden (Thunder): Rain + lightning bolts every ~4s (3-frame flash cycle)
  - Taake (Fog): Cloud blobs drifting through right side of zone
  - Delvis skyet: Same as sun
  - Sludd: Same as rain
- Animation runs at ~3 FPS (0.35s tick interval)
- Animation alpha values tuned for LED hardware visibility (65-180 range)

**Norske teikn / Norwegian Character Support (DOC-13):**
- BDF bitmap fonts: 3 sizes (4x6, 5x8, 7x13)
- Fonts converted from BDF to PIL format at runtime (fonts.py)
- Norwegian-specific: ae (ae), oe (oe), aa (aa) in day names (loerdag, soendag)
- Manual Norwegian day/month dictionaries in clock.py (avoids system locale dependency)
- .pil/.pbm files in .gitignore -- regenerated from BDF source

**Feilhåndtering / Error Resilience (DOC-14):**
- Staleness tracking: bus data stale at 3 min, too old at 10 min; weather stale at 30 min, too old at 1 hour
- Last-good-data preservation: on API failure, keep showing last successful data
- Visual staleness indicator: orange dot at top-right of zone when data is stale but still usable
- Dash placeholders: "--" shown when data is too old
- Connection refresh: pixoo library's refresh_connection_automatically prevents ~300-push lockup
- Brightness cap: MAX_BRIGHTNESS=90% prevents device crashes at full brightness
- Auto-brightness: 20% at night (21:00-06:00), 100% during day

**Bursdagsoverraskelse / Birthday Easter Egg (DOC-15):**
- Configure dates in BIRTHDAY_DATES env var (comma-separated MM-DD format)
- On configured dates: clock text turns golden, date text turns pink
- Small 5x5 pixel crown icon appears at top-right corner
- Deterministic sparkle pixels in clock/date zone

Use `<details>` collapsible sections for the longer technical sections (weather animations, error resilience) to keep the README manageable. The Discord and birthday sections can be shorter and not need collapsing.

**IMPORTANT:** All descriptions must accurately reflect the actual source code. Do NOT invent features or behaviors. Every technical claim should be verifiable by reading the referenced source files.
  </action>
  <verify>
- Discord section matches actual discord_bot.py behavior (MessageBridge, clear/cls/reset commands, daemon thread)
- Weather animation types match the 8 classes in weather_anim.py (RainAnimation, SnowAnimation, etc.)
- Font section mentions all 3 BDF sizes from assets/fonts/
- Error resilience thresholds match constants in main.py (180s, 600s, 1800s, 3600s)
- Birthday section mentions BIRTHDAY_DATES env var format and visual effects from renderer.py
- All text in Norwegian bokmaal
- No real personal data
  </verify>
  <done>All 15 DOC requirements (DOC-01 through DOC-15) are now covered in README.md</done>
</task>

</tasks>

<verification>
- [ ] README.md contains all 15 DOC requirement sections
- [ ] Architecture module map matches actual file structure
- [ ] API URLs match config.py constants
- [ ] Discord commands match actual discord_bot.py code
- [ ] Animation types match weather_anim.py classes
- [ ] Font sizes match assets/fonts/ directory
- [ ] Error thresholds match main.py constants
- [ ] Birthday config matches config.py BIRTHDAY_DATES pattern
- [ ] Technical details verified against source code (no invented features)
- [ ] Collapsible sections used for lengthy technical content
- [ ] All content in Norwegian bokmaal
- [ ] Zero personal data leakage
</verification>

<success_criteria>
A developer who reads the full README can:
1. Understand the architecture and navigate the codebase
2. Know how the Entur and MET Norway APIs are used (and their gotchas)
3. Set up Discord message override if desired
4. Understand the weather animation depth system
5. Know how Norwegian characters are handled
6. Understand the error resilience strategy
7. Discover and configure the birthday easter egg
All technical claims in the README are verifiable against the actual source code.
</success_criteria>

<output>
After completion, create `.planning/phases/08-norwegian-readme/08-02-SUMMARY.md`
</output>
