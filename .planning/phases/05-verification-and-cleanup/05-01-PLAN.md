---
phase: 05-verification-and-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/04-polish-and-reliability/04-VERIFICATION.md
  - .planning/REQUIREMENTS.md
  - src/main.py
  - tests/test_renderer.py
autonomous: true
requirements:
  - DISP-04
  - BUS-04
  - RLBL-02
  - RLBL-03
  - MSG-01

must_haves:
  truths:
    - "Phase 4 VERIFICATION.md exists with evidence for all 5 requirements (DISP-04, BUS-04, RLBL-02, RLBL-03, MSG-01)"
    - "Staleness indicator dot rendering has test coverage (bus stale, weather stale, not-stale, too-old suppression)"
    - "Dead fonts['large'] entry is removed from build_font_map() and test FONTS dict"
    - "REQUIREMENTS.md checkboxes and traceability table show all 5 Phase 4 requirements as complete"
  artifacts:
    - path: ".planning/phases/04-polish-and-reliability/04-VERIFICATION.md"
      provides: "Phase 4 verification evidence for all 5 requirements"
      contains: "DISP-04"
    - path: "tests/test_renderer.py"
      provides: "Staleness dot rendering test coverage"
      contains: "staleness"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated requirement checkboxes and traceability"
      contains: "[x] **DISP-04**"
  key_links:
    - from: ".planning/phases/04-polish-and-reliability/04-VERIFICATION.md"
      to: "src/config.py, src/display/layout.py, src/display/renderer.py, src/main.py, src/providers/discord_bot.py, com.divoom-hub.dashboard.plist"
      via: "Evidence citations referencing file/function/line"
      pattern: "get_target_brightness|urgency_color|bus_stale|KeepAlive|MessageBridge"
    - from: "tests/test_renderer.py"
      to: "src/display/renderer.py"
      via: "render_frame() call and pixel inspection"
      pattern: "getpixel.*62.*BUS_ZONE"
---

<objective>
Close the 5 partial-status gaps from the v1.0 milestone audit by creating the missing Phase 4 VERIFICATION.md, adding staleness dot test coverage, removing dead code, and updating requirement checkboxes.

Purpose: The v1.0 audit confirmed all Phase 4 features are implemented and wired end-to-end, but the Phase 4 VERIFICATION.md artifact was never created. This single missing artifact (plus minor tech debt) is the sole blocker for milestone completion.

Output: Phase 4 VERIFICATION.md, updated test file with staleness coverage, cleaned build_font_map(), updated REQUIREMENTS.md
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md
@.planning/phases/05-verification-and-cleanup/05-RESEARCH.md
@.planning/phases/01-foundation/01-VERIFICATION.md (format reference)
@.planning/phases/04-polish-and-reliability/04-01-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-02-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-03-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-04-SUMMARY.md
@.planning/phases/04-polish-and-reliability/04-05-SUMMARY.md
@src/config.py
@src/main.py
@src/display/renderer.py
@src/display/layout.py
@src/display/state.py
@src/providers/discord_bot.py
@com.divoom-hub.dashboard.plist
@tests/test_renderer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 4 VERIFICATION.md and update REQUIREMENTS.md</name>
  <files>
    .planning/phases/04-polish-and-reliability/04-VERIFICATION.md
    .planning/REQUIREMENTS.md
  </files>
  <action>
Create `.planning/phases/04-polish-and-reliability/04-VERIFICATION.md` following the exact format established by 01-VERIFICATION.md, 02-VERIFICATION.md, and 03-VERIFICATION.md. The file must have:

**Frontmatter:**
- phase: 04-polish-and-reliability
- verified: [current ISO timestamp]
- status: passed
- score: N/N must-haves verified
- re_verification: false
- gaps: []

**Content sections (each with REAL evidence from current source code):**

1. **Observable Truths** — One row per Phase 4 success criterion (from ROADMAP.md):
   - Bus departures color-coded by urgency (evidence: `urgency_color()` in layout.py, per-departure coloring in renderer.py `_draw_bus_line()`)
   - Display brightness adjusts by time of day (evidence: `get_target_brightness()` in config.py, brightness tracking in main loop)
   - API failure shows last known data with staleness indicator (evidence: `last_good_bus`/`last_good_weather` preservation in main.py, staleness flags in state.py, orange dot in renderer.py)
   - Service auto-restarts after crash (evidence: `com.divoom-hub.dashboard.plist` with RunAtLoad + KeepAlive/SuccessfulExit=false)
   - Text message overrides display (evidence: `MessageBridge` in discord_bot.py, `_render_message()` in renderer.py, `message_text` in state.py)

2. **Required Artifacts** — List each source file implementing Phase 4 features with exists/substantive/wired status.

3. **Key Link Verification** — Trace critical connections:
   - urgency_color() -> renderer per-departure coloring
   - get_target_brightness() -> main loop brightness scheduling
   - staleness flags -> orange dot rendering
   - launchd plist -> process supervision
   - Discord bot -> MessageBridge -> renderer message overlay

4. **Requirements Coverage** — Map each of DISP-04, BUS-04, RLBL-02, RLBL-03, MSG-01 to source plans and evidence.

5. **Anti-Patterns Found** — Run `ruff check src/` and report results.

6. **Test Results** — Run `python -m pytest tests/ -v` and summarize.

CRITICAL: Verify all evidence against the CURRENT codebase, not SUMMARY descriptions. Line numbers may have shifted due to post-UAT 04-05 changes. Re-read source files before writing evidence.

**Then update REQUIREMENTS.md:**
- Change 5 checkboxes from `[ ]` to `[x]` for DISP-04, BUS-04, RLBL-02, RLBL-03, MSG-01
- Update traceability table: change Status from "Pending" to "Complete" for those 5 rows
- Update Phase column from "Phase 5" to "Phase 4" for those 5 rows (they were implemented in Phase 4, verified in Phase 5)
  </action>
  <verify>
- `cat .planning/phases/04-polish-and-reliability/04-VERIFICATION.md | head -10` shows valid YAML frontmatter with status: passed
- `grep -c "VERIFIED" .planning/phases/04-polish-and-reliability/04-VERIFICATION.md` returns 5 (one per truth)
- `grep -c "\[x\]" .planning/REQUIREMENTS.md` returns 19 (all v1 requirements checked)
- `grep "Pending" .planning/REQUIREMENTS.md` returns no matches in v1 section
  </verify>
  <done>Phase 4 VERIFICATION.md exists with evidence for all 5 requirements. REQUIREMENTS.md shows all 19 v1 requirements as complete with consistent traceability table.</done>
</task>

<task type="auto">
  <name>Task 2: Add staleness dot tests and remove dead fonts["large"] code</name>
  <files>
    tests/test_renderer.py
    src/main.py
  </files>
  <action>
**Part A: Add staleness dot test coverage to tests/test_renderer.py**

Add 4 test functions for the staleness indicator dot:

1. `test_bus_staleness_dot_renders_when_stale()` — Create DisplayState with `bus_stale=True, bus_too_old=False`, render frame, assert pixel at `(62, BUS_ZONE.y + 1)` equals `COLOR_STALE_INDICATOR` (255, 100, 0).

2. `test_bus_staleness_dot_absent_when_not_stale()` — Create DisplayState with `bus_stale=False`, render frame, assert pixel at `(62, BUS_ZONE.y + 1)` does NOT equal `COLOR_STALE_INDICATOR`.

3. `test_bus_staleness_dot_absent_when_too_old()` — Create DisplayState with `bus_stale=True, bus_too_old=True`, render frame, assert pixel at `(62, BUS_ZONE.y + 1)` does NOT equal `COLOR_STALE_INDICATOR`. (too_old suppresses the dot — shows dash placeholders instead)

4. `test_weather_staleness_dot_renders_when_stale()` — Create DisplayState with `weather_stale=True, weather_too_old=False`, render frame, assert pixel at `(62, WEATHER_ZONE.y + 1)` equals `COLOR_STALE_INDICATOR`.

Import `BUS_ZONE`, `WEATHER_ZONE`, and `COLOR_STALE_INDICATOR` from `src.display.layout`. Use the existing `FONTS` dict and `render_frame()` already imported in the test file. Provide bus_direction1/bus_direction2 tuples for stale tests (the dot only renders when bus data exists). Use the pattern `frame.getpixel((x, y))` to inspect pixel colors. Include descriptive docstrings explaining what each test verifies.

**Part B: Remove dead fonts["large"] from build_font_map() and test file**

In `src/main.py`:
1. Remove `"large": raw_fonts[FONT_LARGE],` from the return dict in `build_font_map()` (line ~66)
2. Remove `FONT_LARGE` from the import statement (line ~30)
3. Update the `build_font_map()` docstring to say `"small", "tiny"` instead of `"large", "small", "tiny"`

In `tests/test_renderer.py`:
1. Remove `"large": _raw_fonts[FONT_LARGE],` from the FONTS dict (line ~15)
2. Remove `FONT_LARGE` from the import statement (line ~7)

Do NOT remove `FONT_LARGE` from `src/config.py` — the constant is inert and its removal is outside the audit scope.
  </action>
  <verify>
- `python -m pytest tests/test_renderer.py -v -k staleness` — all 4 staleness tests pass
- `python -m pytest tests/ -v` — full suite passes with no regressions
- `grep -c "FONT_LARGE" src/main.py` returns 0
- `grep -c '"large"' src/main.py` returns 0
- `grep -c "FONT_LARGE" tests/test_renderer.py` returns 0
- `grep -c '"large"' tests/test_renderer.py` returns 0
  </verify>
  <done>4 staleness dot tests pass (bus stale, bus not-stale, bus too-old suppression, weather stale). Dead fonts["large"] entry removed from build_font_map() and test FONTS dict. Full test suite passes.</done>
</task>

</tasks>

<verification>
1. Phase 4 VERIFICATION.md exists at `.planning/phases/04-polish-and-reliability/04-VERIFICATION.md` with status: passed
2. All 5 requirements (DISP-04, BUS-04, RLBL-02, RLBL-03, MSG-01) have evidence in VERIFICATION.md
3. REQUIREMENTS.md shows all 19 v1 requirements checked `[x]` with "Complete" status in traceability table
4. 4 new staleness dot tests pass in test_renderer.py
5. `fonts["large"]` removed from build_font_map() and test FONTS dict
6. Full test suite (`python -m pytest tests/ -v`) passes with no regressions
7. `ruff check src/` passes clean
</verification>

<success_criteria>
- Phase 4 VERIFICATION.md exists with VERIFIED evidence for all 5 Phase 4 requirements
- REQUIREMENTS.md shows 19/19 v1 requirements complete (0 pending)
- 4 staleness dot tests pass (bus stale, bus not-stale, bus too-old suppression, weather stale)
- Dead `fonts["large"]` entry removed from production and test code
- Full test suite passes with 0 failures
- v1.0 milestone audit gaps are fully closed
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-and-cleanup/05-01-SUMMARY.md`
</output>
