---
phase: 02-bus-departures
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/display/layout.py
  - src/display/renderer.py
  - src/main.py
  - tests/test_renderer.py
autonomous: false
requirements: [BUS-01, BUS-02, BUS-03, BUS-05]

must_haves:
  truths:
    - "Bus zone shows two lines: direction 1 (Sentrum) on top, direction 2 (Lade) below"
    - "Each line shows arrow+letter label in a distinct color plus two bare countdown numbers"
    - "Bus data refreshes every 60 seconds independently from the 1-second display check"
    - "Dashboard continues running when Entur API is unreachable"
  artifacts:
    - path: "src/display/layout.py"
      provides: "Bus zone color constants for direction labels and countdown text"
      contains: "COLOR_BUS"
    - path: "src/display/renderer.py"
      provides: "Bus zone rendering function drawing two direction lines"
      contains: "render_bus_zone"
    - path: "src/main.py"
      provides: "Main loop with independent 60-second bus fetch timer"
      contains: "last_bus_fetch"
    - path: "tests/test_renderer.py"
      provides: "Renderer tests verifying bus zone has colored pixels when bus data present"
      contains: "test_"
  key_links:
    - from: "src/display/renderer.py"
      to: "src/display/state.py"
      via: "reads bus_direction1 and bus_direction2 from DisplayState"
      pattern: "state\\.bus_direction"
    - from: "src/display/renderer.py"
      to: "src/display/layout.py"
      via: "uses BUS_ZONE coordinates and COLOR_BUS constants"
      pattern: "BUS_ZONE|COLOR_BUS"
    - from: "src/main.py"
      to: "src/providers/bus.py"
      via: "calls fetch_bus_data() every 60 seconds"
      pattern: "fetch_bus_data"
    - from: "src/main.py"
      to: "src/display/state.py"
      via: "passes bus_data tuple to DisplayState.from_now()"
      pattern: "from_now.*bus_data"
---

<objective>
Render live bus departure data in the 19px bus zone and integrate the 60-second fetch cycle into the main loop, replacing the placeholder "BUS" text with real direction labels and countdown numbers.

Purpose: This is the user-visible deliverable -- real bus departures appear on the physical Pixoo 64 display, completing Phase 2.

Output: Updated renderer with bus zone drawing, updated main loop with independent bus refresh timer, and a visual verification checkpoint on the physical device.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bus-departures/02-RESEARCH.md
@.planning/phases/02-bus-departures/02-01-SUMMARY.md

Key existing files (will be modified by Plan 01 -- read fresh):
@src/display/layout.py
@src/display/renderer.py
@src/main.py
@src/display/state.py
@src/providers/bus.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bus zone renderer and main loop integration</name>
  <files>src/display/layout.py, src/display/renderer.py, src/main.py, tests/test_renderer.py</files>
  <action>
**1. Add bus color constants to `src/display/layout.py`:**
- `COLOR_BUS_DIR1 = (100, 200, 255)` -- Light blue for Sentrum direction (arrow+letter)
- `COLOR_BUS_DIR2 = (255, 180, 50)` -- Amber/orange for Lade direction (arrow+letter)
- `COLOR_BUS_TIME = (255, 255, 255)` -- White for departure countdown numbers

These are Claude's discretion colors (user said "pick two distinct, readable colors for LED display"). Light blue and amber provide strong contrast against black background and against each other.

**2. Update `src/display/renderer.py`:**

Replace the bus zone placeholder block with a `render_bus_zone()` helper function called from `render_frame()`.

The bus zone is 19px tall (y=24 to y=42). Layout within the zone:
- Use the "tiny" (4x6) font for direction labels and the "small" (5x8) font for countdown numbers (better readability for the actual data)
- Line 1 (direction 1 / Sentrum): y = BUS_ZONE.y + 1 (1px top padding)
- Line 2 (direction 2 / Lade): y = BUS_ZONE.y + 10 (1px gap after 8px line height)
- This gives: 1px padding + 8px line1 + 1px gap + 8px line2 + 1px padding = 19px exactly

For each direction line:
- Draw arrow+letter label at x=TEXT_X in the direction's color. Use `>` for direction 1 (Sentrum, rightward) and `<` for direction 2 (Lade, leftward). ASCII `>` and `<` are guaranteed present in the BDF fonts (per research open question -- use ASCII as the safe fallback).
- Draw the two countdown numbers after the label, separated by 2+ spaces, in white (COLOR_BUS_TIME)
- Format: `>S  5  12` for direction 1, `<L  3  8` for direction 2

Handle edge cases (Claude's discretion items):
- **No bus data (None):** Show dashes `-- --` in dim gray (COLOR_PLACEHOLDER) for that direction. This indicates "no data" clearly without a distracting message.
- **Empty list (API returned 0 departures):** Show `--` for each missing departure slot.
- **0 minutes countdown:** Display `0` (not "Na" -- keep it numeric and consistent).
- **Long waits (60+ minutes):** Show the raw number. At 4x6 font, 3-digit numbers like "120" still fit. Only if >999 would there be an issue, which is unrealistic for bus departures.

Import new color constants from layout.py in renderer.py.

**3. Update `src/main.py` main_loop():**

Add the 60-second independent bus refresh timer:
- Import `fetch_bus_data` from `src.providers.bus`
- Import `BUS_REFRESH_INTERVAL` from `src.config`
- Add `last_bus_fetch = 0.0` and `bus_data = (None, None)` before the while loop
- Inside the loop, before building DisplayState:
  ```python
  now_mono = time.monotonic()
  if now_mono - last_bus_fetch >= BUS_REFRESH_INTERVAL:
      bus_data = fetch_bus_data()
      last_bus_fetch = now_mono
      logger.info("Bus data refreshed: dir1=%s dir2=%s", bus_data[0], bus_data[1])
  ```
- Update `DisplayState.from_now(now)` call to `DisplayState.from_now(now, bus_data=bus_data)`
- The first fetch happens immediately on startup (because `0.0 - 0.0 >= 60` is false, so actually initialize `last_bus_fetch = -BUS_REFRESH_INTERVAL` to trigger immediate first fetch, or set `last_bus_fetch = 0.0` and use `time.monotonic()` which starts from system boot and will always be > 60)

Actually, simplest approach: initialize `last_bus_fetch = 0.0`. Since `time.monotonic()` returns seconds since an arbitrary reference point (usually system boot, always > 60 on any running system), the first check `monotonic() - 0.0 >= 60` will be True immediately. This triggers the first bus fetch on the very first loop iteration. Clean and no special-casing needed.

**4. Update `tests/test_renderer.py`:**

Add tests verifying bus zone rendering:
- Test that when DisplayState has bus_direction1=(5, 12) and bus_direction2=(3, 8), the bus zone area (y=24 to y=42) contains non-black pixels (colored text was drawn)
- Test that when bus data is None, the bus zone still renders without crashing (shows dashes)
- Test that the rendered image is still 64x64 RGB

Ensure existing renderer tests still pass -- they should, since the clock and date zones are unchanged.
  </action>
  <verify>Run `python -m pytest tests/ -v` -- all tests pass. Run `python src/main.py --simulated --save-frame` for a few seconds (Ctrl+C) and inspect `debug_frame.png` -- bus zone should show direction labels and countdown numbers (or dashes if API fails). Run `ruff check src/display/layout.py src/display/renderer.py src/main.py` -- no lint errors.</verify>
  <done>Bus zone renders two direction lines with colored labels and white countdown numbers. Main loop fetches bus data every 60 seconds. Placeholder "BUS" text is replaced with live data. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify bus departures on physical Pixoo 64</name>
  <files>debug_frame.png</files>
  <action>
CHECKPOINT: Human verification of bus departures on the physical Pixoo 64.

What was built: Complete bus departure display -- real-time Entur data showing next 2 departures for both Sentrum and Lade directions, refreshing every 60 seconds, rendered in the bus zone of the 64x64 dashboard.

How to verify:

1. First check the rendered frame without hardware:
   - Run `python src/main.py --simulated --save-frame` for a few seconds (Ctrl+C to stop)
   - Open `debug_frame.png` in an image viewer
   - Verify: bus zone shows two lines with direction labels and countdown numbers
   - If the frame looks wrong, describe what's off before proceeding to device

2. Run on the physical device:
   ```bash
   cd /Users/jdl/Documents/GitHub/divoom-hub
   source .venv/bin/activate
   python src/main.py --ip YOUR_PIXOO_IP
   ```

3. Verify on the physical Pixoo 64:
   - [ ] Clock and date at top (unchanged from Phase 1)
   - [ ] Bus zone shows two lines:
     - Top line: blue `>S` label followed by two white countdown numbers (Sentrum direction)
     - Bottom line: amber `<L` label followed by two white countdown numbers (Lade direction)
   - [ ] Weather zone placeholder at bottom (unchanged)
   - [ ] Countdown numbers are reasonable (match expected Ladeveien departures)
   - [ ] Can you read the bus times from 2+ meters away?

4. Wait 60+ seconds and verify the numbers update (countdown should decrease by ~1 each minute)

5. If no buses are running (late night), you should see dashes `-- --` instead of numbers.
   If the bus zone shows dashes but everything else looks fine, the API might be unreachable -- check the terminal for error logs.

Resume signal: Type "approved" if bus departures display correctly, or describe any issues you see.
  </action>
  <verify>User confirms bus departures display correctly on the physical Pixoo 64 device with readable countdown numbers.</verify>
  <done>Physical Pixoo 64 shows: two direction lines with colored labels (blue Sentrum, amber Lade), white countdown numbers, data refreshing every 60 seconds, and stable operation alongside the existing clock/date display.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- all tests pass (clock, fonts, renderer, bus provider)
2. Physical Pixoo 64 shows real bus departure countdowns for both directions
3. Countdown numbers update after 60-second refresh cycle
4. Dashboard continues running smoothly (no crashes, no freezes)
5. `ruff check src/` -- no lint errors across the project
</verification>

<success_criteria>
- Bus zone displays two lines: Sentrum direction (blue label) and Lade direction (amber label)
- Each line shows arrow+letter label and two bare countdown numbers
- Numbers reflect actual upcoming bus departures from Ladeveien
- Data refreshes every 60 seconds (visible in terminal logs)
- Dashboard is stable -- clock continues updating, no crashes when API is slow or down
- User confirms readability on physical device
</success_criteria>

<output>
After completion, create `.planning/phases/02-bus-departures/02-02-SUMMARY.md`
</output>
