---
phase: 04-polish-and-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.py
  - src/display/layout.py
  - src/display/renderer.py
  - src/display/weather_anim.py
  - src/display/weather_icons.py
  - src/device/pixoo_client.py
  - src/main.py
autonomous: true
requirements: [DISP-04]
must_haves:
  truths:
    - "Display dims automatically between 21:00 and 06:00"
    - "Display runs at full brightness during daytime (06:00-21:00)"
    - "Brightness only changes when the target level changes (not every frame)"
    - "The display has a cohesive color palette -- not grey/monochrome"
    - "Clock is smaller, freeing space for other zones"
    - "Weather animations use vivid colors (blue rain, white snow, yellow sun)"
    - "The display is both usable and fun to look at on LED hardware"
  artifacts:
    - path: "src/config.py"
      provides: "Brightness schedule constants"
    - path: "src/display/layout.py"
      provides: "Revised zone heights, new color palette"
    - path: "src/display/renderer.py"
      provides: "Updated rendering with new zone positions and colors"
    - path: "src/display/weather_anim.py"
      provides: "Vivid animation colors per weather type"
    - path: "src/main.py"
      provides: "Brightness scheduling in main loop"
  key_links:
    - from: "src/main.py"
      to: "src/device/pixoo_client.py"
      via: "set_brightness called when target changes"
      pattern: "set_brightness|get_target_brightness"
    - from: "src/display/layout.py"
      to: "src/display/renderer.py"
      via: "Revised zone constants and color palette"
      pattern: "CLOCK_ZONE|COLOR_"
---

<objective>
Add auto-brightness scheduling and perform a complete visual color overhaul of the dashboard.

Purpose: The display should dim at night (not wake anyone up) and run bright during the day. The current dashboard is too grey/monochrome and the clock dominates -- this plan rebalances zones and applies a cohesive color palette that makes the LED display both usable and fun to look at. Weather animations get vivid colors (the existing todo about grey rain/snow is addressed here).

Output: Brightness scheduling in main loop, revised zone layout with smaller clock, new color palette across all zones, vivid weather animation colors.
</objective>

<execution_context>
@/Users/jdl/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jdl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-and-reliability/04-RESEARCH.md
@.planning/phases/04-polish-and-reliability/04-CONTEXT.md
@src/config.py
@src/display/layout.py
@src/display/renderer.py
@src/display/weather_anim.py
@src/display/weather_icons.py
@src/device/pixoo_client.py
@src/main.py
@.planning/todos/pending/2026-02-20-weather-animation-and-rain-text-colors-indistinguishable.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-brightness scheduling</name>
  <files>src/config.py, src/main.py</files>
  <action>
  1. In `src/config.py`, add brightness schedule constants:
     - `BRIGHTNESS_NIGHT = 20` -- 20% (within user's 15-25% range, readable but not room-lighting)
     - `BRIGHTNESS_DAY = 100` -- 100% (PixooClient caps at MAX_BRIGHTNESS=90)
     - `BRIGHTNESS_DIM_START = 21` -- hour when night mode starts (21:00)
     - `BRIGHTNESS_DIM_END = 6` -- hour when day mode starts (06:00)

  2. In `src/config.py`, add a helper function:
     ```python
     def get_target_brightness(hour: int) -> int:
         """Return target brightness based on hour of day.
         Night mode (21:00-06:00): dim. Day mode (06:00-21:00): full.
         """
         if hour >= BRIGHTNESS_DIM_START or hour < BRIGHTNESS_DIM_END:
             return BRIGHTNESS_NIGHT
         return BRIGHTNESS_DAY
     ```

  3. In `src/main.py`, add brightness tracking to main_loop:
     - Add `last_brightness: int = -1` before the while loop
     - Inside the loop, after getting `now = datetime.now()`:
       ```python
       target_brightness = get_target_brightness(now.hour)
       if target_brightness != last_brightness:
           client.set_brightness(target_brightness)
           last_brightness = target_brightness
           logger.info("Brightness set to %d%%", target_brightness)
       ```
     - This only calls `set_brightness` when the target changes (at 06:00 and 21:00), not every frame.
     - Remove the single `client.set_brightness(MAX_BRIGHTNESS)` call from `main()` -- brightness is now managed by the loop.
  </action>
  <verify>
  1. Run `python src/main.py --simulated --save-frame`
  2. Check logs show brightness being set on startup
  3. Verify `get_target_brightness()` returns correct values for edge cases: hour 0, 5, 6, 20, 21, 23
  </verify>
  <done>Brightness automatically adjusts based on time of day. Night mode (21:00-06:00) at 20%, day mode at full. Only sends brightness command when target changes.</done>
</task>

<task type="auto">
  <name>Task 2: Visual color overhaul -- zone rebalancing and color palette</name>
  <files>src/display/layout.py, src/display/renderer.py, src/display/weather_anim.py, src/display/weather_icons.py</files>
  <action>
  **Part A: Zone rebalancing (smaller clock)**

  In `src/display/layout.py`, shrink clock zone and redistribute space:
  - Current: clock 14px + date 9px + div 1px + bus 19px + div 1px + weather 20px = 64px
  - New: clock 11px + date 8px + div 1px + bus 19px + div 1px + weather 24px = 64px
  - The clock loses 3px (use 5x8 font instead of 7x13 for time -- still very readable on LED)
  - Date loses 1px (tighter vertical padding)
  - Weather gains 4px (more room for message overlay in future plan)

  Update all Zone constants to reflect new y positions:
  ```python
  CLOCK_ZONE = Zone(name="clock", x=0, y=0, width=64, height=11)
  DATE_ZONE = Zone(name="date", x=0, y=11, width=64, height=8)
  DIVIDER_1 = Zone(name="divider_1", x=0, y=19, width=64, height=1)
  BUS_ZONE = Zone(name="bus", x=0, y=20, width=64, height=19)
  DIVIDER_2 = Zone(name="divider_2", x=0, y=39, width=64, height=1)
  WEATHER_ZONE = Zone(name="weather", x=0, y=40, width=64, height=24)
  ```

  **Part B: New color palette**

  In `src/display/layout.py`, replace the current grey/monochrome colors with a cohesive LED-friendly palette:

  ```python
  # Clock -- warm white, slightly golden for LED warmth
  COLOR_TIME = (255, 240, 200)

  # Date -- soft cyan tint (not grey)
  COLOR_DATE = (120, 200, 220)

  # Dividers -- subtle teal (not grey)
  COLOR_DIVIDER = (30, 60, 60)

  # Placeholders -- dark teal (not grey)
  COLOR_PLACEHOLDER = (40, 60, 60)

  # Bus zone -- keep existing direction colors (already good)
  # COLOR_BUS_DIR1 = (100, 200, 255) -- light blue, keep
  # COLOR_BUS_DIR2 = (255, 180, 50) -- amber, keep
  # COLOR_BUS_TIME removed -- urgency colors from plan 04-01 handle this

  # Weather zone -- vivid palette
  COLOR_WEATHER_TEMP = (255, 255, 255)          # White for positive temp
  COLOR_WEATHER_TEMP_NEG = (100, 180, 255)      # Brighter blue for negative
  COLOR_WEATHER_HILO = (120, 180, 160)          # Soft teal for hi/lo (not grey)
  COLOR_WEATHER_RAIN = (50, 180, 255)           # Vivid blue for rain text
  ```

  **Part C: Weather animation vivid colors**

  In `src/display/weather_anim.py`, update animation colors for each weather type. This addresses the pending todo about grey/indistinguishable particles:

  - **Rain particles:** Light blue `(80, 160, 255, alpha)` -- clearly reads as water drops
  - **Heavy rain:** Brighter blue `(60, 140, 255, alpha)` with larger drops
  - **Snow particles:** Bright white `(220, 230, 255, alpha)` -- reads as snow/ice
  - **Thunderstorm:** Blue rain + yellow/white flash `(255, 255, 100, alpha)` for lightning
  - **Fog/mist:** Soft white `(180, 190, 200, alpha)` wisps
  - **Sun clear:** Warm yellow-orange `(255, 200, 80, alpha)` for sun rays/shimmer
  - **Partly cloudy:** Subtle grey-white `(160, 170, 180, alpha)` clouds drifting

  Find each animation class (RainAnimation, HeavyRainAnimation, SnowAnimation, ThunderAnimation, FogAnimation, ClearAnimation, PartlyCloudyAnimation) and update the particle/effect fill colors from the current grey values to the vivid colors above.

  Maintain the existing alpha ranges (65-150) that were tuned for LED visibility in Phase 3 gap closure.

  **Part D: Renderer updates for new zone positions**

  In `src/display/renderer.py`:
  - Update the clock rendering to use `fonts["small"]` (5x8) instead of `fonts["large"]` (7x13) for the time string. The smaller font still fills the 11px zone height well.
  - Update the weather icon sizing if needed (icon is positioned relative to clock text).
  - Ensure all zone rendering references zone constants from layout.py (not hardcoded positions).
  - The weather zone animation frame size must be updated from 64x20 to 64x24 to match the new zone height.

  NOTE: Since plan 04-01 runs in parallel (same wave), do NOT assume urgency colors exist yet. Just keep using whatever bus time color is in layout.py. The two plans touch different rendering functions and will merge cleanly.
  </action>
  <verify>
  1. Run `python src/main.py --simulated --save-frame` and inspect `debug_frame.png`:
     - Clock should be smaller, not dominating the display
     - Date should have a teal tint
     - Weather animations should show color (blue rain, white snow, yellow sun)
     - Overall feel should be colorful, not grey
  2. Run existing tests to verify nothing breaks
  3. Verify zone math: all zone heights sum to 64px exactly
  </verify>
  <done>Display has a cohesive color palette with warm clock, teal accents, vivid weather animations. Clock is smaller, zones rebalanced. Brightness auto-adjusts by time of day. Weather animation color todo resolved.</done>
</task>

</tasks>

<verification>
- [ ] Brightness dims at 21:00 (or simulated check) and brightens at 06:00
- [ ] Brightness only sent to device when target changes
- [ ] Clock zone smaller (11px vs 14px)
- [ ] New color palette visible -- no more all-grey/monochrome feel
- [ ] Weather animations use vivid colors per weather type
- [ ] Rain particles are blue (not grey), snow is white, sun is warm yellow
- [ ] Zone heights sum to 64px
- [ ] All existing tests pass
- [ ] Pending weather animation color todo addressed
</verification>

<success_criteria>
Display brightness adapts to time of day automatically. The dashboard has a cohesive, vivid color palette that is both usable and fun to look at on LED hardware. Clock no longer dominates the display.
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-and-reliability/04-02-SUMMARY.md`
</output>
